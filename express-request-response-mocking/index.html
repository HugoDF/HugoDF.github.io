<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="gBfbdXRLofaOyHsbgiSiuCIHKPaviGMRVWh_qOfDHNE" />

    <title>A guide to Express request and response mocking/stubbing with Jest or sinon &middot; Code with Hugo</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#090a0b">

    <link rel="shortcut icon" href="https://codewithhugo.com/favicon.ico" />
    <meta name="theme-color" content="#090a0b">
    
    <link rel="canonical" href="https://codewithhugo.com/express-request-response-mocking/" /> 

     <meta name="description" content="&lt;p&gt;To test an Express handler, it’s useful to know how to successfully mock/stub the &lt;code&gt;request&lt;/code&gt; and &lt;code&gt;response&lt;/code&gt; objects. The following examp" /> 

     
    
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://codewithhugo.com/img/chris-barbalis-unsplash.jpg"/>
    
 
    <meta name="twitter:title" content="A guide to Express request and response mocking/stubbing with Jest or sinon"/>
    <meta name="twitter:description" content="&lt;p&gt;To test an Express handler, it’s useful to know how to successfully mock/stub the &lt;code&gt;request&lt;/code&gt; and &lt;code&gt;response&lt;/code&gt; objects. The following examp"/>
    <meta name="twitter:url" content="https://codewithhugo.com/express-request-response-mocking" />
    <meta name="twitter:site" content="@hugo__df"/>

    <meta property="og:site_name" content="Code with Hugo" />
    <meta property="og:title" content="A guide to Express request and response mocking/stubbing with Jest or sinon &middot; Code with Hugo" />
    <meta property="og:url" content="https://codewithhugo.com/express-request-response-mocking/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="&lt;p&gt;To test an Express handler, it’s useful to know how to successfully mock/stub the &lt;code&gt;request&lt;/code&gt; and &lt;code&gt;response&lt;/code&gt; objects. The following examp" />

    <meta property="article:published_time" content="2019-02-18T00:00:00Z" />
    <meta property="article:tag" content="Node" /><meta property="article:tag" content="Testing" /><meta property="article:tag" content="JavaScript" />

    <meta property="og:image" content="https://codewithhugo.com/img/chris-barbalis-unsplash.jpg"/>


    <meta name="generator" content="Hugo 0.46" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/css/casper-two.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/overrides.min.b03e9c043a50092b43f3ef9ab0b468b08690a8f8f1b270a7b31ff5ab68a94763.css">
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/syntax.min.e1646a3f88f77e1b5e7d0253633b1958013aa132890dfe4d7e15dc4718d4aecc.css">
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/cta.min.e78c0bb9686c3a53ce9ba4c0d5c59abfa16cc34c2a616a001f7e4b473644374c.css">
    

    

     
</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/guides/">guides</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/javascript/">JavaScript</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/node/">Node</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/testing/">Testing</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/deployment/">Deployment</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/">More...</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="https://checkoutpage.co/checkout/hugo/consulting-fee">Contact</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/open/">#open</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    <a class="social-link social-link-tw" href="https://twitter.com/hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg></a>

                    <a class="social-link" href="https://github.com/HugoDF" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    <a class="social-link" href="https://medium.com/@hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 195 195"><path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z"/></svg></a>
        </div>  
        
        <a class="subscribe-button" href="https://codewithhugo.com/index.xml">Subscribe</a>
            
      </div>

    </nav>  

  </div>
</header>

<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      <article class="post-full post">
  <header class="post-full-header">
    <section class="post-full-meta">
      <time class="post-full-meta-date"
        datetime="2019-02-18">18 February 2019</time>
      <span class="date-divider">/</span> <a
        href="https://codewithhugo.com/tags/node/">#Node</a>&nbsp;<a
        href="https://codewithhugo.com/tags/testing/">#Testing</a>&nbsp;
    </section>
    <h1 class="post-full-title">A guide to Express request and response mocking/stubbing with Jest or sinon</h1>
  </header>
  <div class="hero-container">

    
    <figure class="post-full-image" style="background-image: url(https://codewithhugo.com/img/chris-barbalis-unsplash.jpg)">
      

    </figure>
  </div>

  <section class="post-full-content">
    <div class="kg-card-markdown">
      <p>To test an Express handler, it’s useful to know how to successfully mock/stub the <code>request</code> and <code>response</code> objects. The following examples will be written both using Jest and sinon (running in AVA).</p>

<p>The rationale for this is the following. Jest is a very popular “all-in-one” testing framework. Sinon is one of the most popular “Standalone test spies, stubs and mocks for JavaScript” which “works with any unit testing framework”.</p>

<p>The approach detailed in this post will be about how to test handlers independently of the Express app instance by calling them directly with mocked request (<code>req</code>)  and response (<code>res</code>) objects. This is only 1 approach to testing Express handlers and middleware. The alternative is to fire up the Express server (ideally in-memory using SuperTest). I go into more detail on how to achieve that in <a href="https://codewithhugo.com/testing-an-express-app-with-supertest-moxios-and-jest/">“Testing an Express app with SuperTest, moxios and Jest”</a>.</p>

<p>One of the big conceptual leaps to testing Express applications with mocked request/response is understanding how to mock a chained API eg. <code>res.status(200).json({ foo: 'bar' })</code>.</p>

<p>This is achieved by returning the <code>res</code> instance from each of its methods:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">mockResponse</span> <span class="o">=</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="c1">// replace the following () =&gt; res
</span><span class="c1"></span>  <span class="c1">// with your function stub/mock of choice
</span><span class="c1"></span>  <span class="c1">// making sure they still return `res`
</span><span class="c1"></span>  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>See the repository with examples and the working application at <a href="https://github.com/HugoDF/mock-express-request-response">github.com/HugoDF/mock-express-request-response</a>.</p>

<p>Table of contents:
</p>
    </div>
    <section class="table-of-contents">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#stubs-and-mocks-jest-fn-vs-sinon">Stubs and mocks: Jest.fn vs sinon</a></li>
<li><a href="#mocking-stubbing-a-chained-api-express-response">Mocking/stubbing a chained API: Express response</a>
<ul>
<li><a href="#mocking-stubbing-req-a-simple-express-request-with-jest-or-sinon">Mocking/stubbing req (a simple Express request) with Jest or sinon</a></li>
<li><a href="#mocking-stubbing-res-a-simple-express-response-with-jest">Mocking/stubbing res (a simple Express response) with Jest</a></li>
<li><a href="#mocking-stubbing-res-a-simple-express-response-with-sinon">Mocking/stubbing res (a simple Express response) with sinon</a></li>
<li><a href="#testing-a-handler-that-reads-from-req-and-sends-a-res-using-status-and-json">Testing a handler that reads from <code>req</code> and sends a <code>res</code> using status and json()</a></li>
<li><a href="#testing-a-handler-that-writes-to-req-and-sends-a-res-using-status-and-json">Testing a handler that writes to  <code>req</code> and sends a <code>res</code> using status and json()</a></li>
</ul></li>
<li><a href="#a-complex-handler-request-response-mocking-scenario-a-request-to-login-with-a-body">A complex handler request/response mocking scenario: a request to login with a body</a>
<ul>
<li><a href="#tests-for-login-handler-using-in-jest">Tests for login handler using in Jest</a></li>
<li><a href="#tests-for-login-handler-using-ava-sinon">Tests for login handler using AVA + sinon</a></li>
</ul></li>
<li><a href="#testing-a-middleware-and-mocking-express-request-get-headers">Testing a middleware and mocking Express request.get headers</a>
<ul>
<li><a href="#updating-mockrequest-to-support-accessing-headers">Updating mockRequest to support accessing headers</a></li>
<li><a href="#testing-a-middleware-that-accesses-headers-with-jest">Testing a middleware that accesses headers with Jest</a></li>
<li><a href="#testing-a-middleware-that-accesses-headers-using-ava-sinon">Testing a middleware that accesses headers using AVA + sinon</a></li>
</ul></li>
<li><a href="#keys-to-testing-express-handlers-and-middleware">Keys to testing Express handlers and middleware</a></li>
</ul></li>
</ul>
</nav>
    </section>
    
    <div id="codefund" class="related-links">
      <span>
        <div class="cf-wrapper">
          <div class="cf-header">Proudly sponsored by</div>
          <a href="https://buttondown.email/hugo" class="cf-text">
            <strong>Enterprise Node.js and JavaScript Guides</strong><br />
            Build your web platform with modern best-practices, tools and patterns
          </a>


          <a href="/" class="cf-powered-by">
            <em>useful</em> products by Code with Hugo
          </a>
        </div>
      </span>
    </div>
    
    <div class="kg-card-markdown">
      
      

<h2 id="stubs-and-mocks-jest-fn-vs-sinon">Stubs and mocks: Jest.fn vs sinon</h2>

<p><code>jest.fn</code> and <code>sinon.stub</code> have the same role. They both return a mock/stub for a function. That just means a function that recalls information about its calls, eg. how many times and what arguments it was called with.</p>

<p>The Jest mock is tightly integrated with the rest of the framework. That means we can have assertions that look like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;jest.fn recalls what it has been called with&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">mock</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">();</span>
  <span class="nx">mock</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">mock</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">mock</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Sinon is “just” a spies/stubs/mocks library, that means we need a separate test runner, the following example is equivalent to the previous Jest one but written using AVA:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ava&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">sinon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sinon&#39;</span><span class="p">);</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;sinon.stub recalls what it has been called with&#39;</span><span class="p">,</span> <span class="nx">t</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">mock</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">();</span>
  <span class="nx">mock</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">mock</span><span class="p">.</span><span class="nx">called</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="mocking-stubbing-a-chained-api-express-response">Mocking/stubbing a chained API: Express response</h2>

<p>The Express user-land API is based around middleware. A middleware that takes a request (usually called <code>req</code>), a response (usually called <code>res</code> ) and a next (call next middleware) as parameters.</p>

<p>A “route handler” is a middleware that tends not to call <code>next</code>, it usually results in a response being sent.</p>

<p>An example of some route handlers are the following (in express-handlers.js).</p>

<p>In this example <code>req.session</code> is generated by <code>client-sessions</code>, a middleware by Mozilla that sets an encrypted cookie that gets set on the client (using a <code>Set-Cookie</code>). That’s beyond the scope of this post. For all intents and purposes, we could be accessing/writing to any other set of request/response properties.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">username</span> <span class="p">});</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">logout</span><span class="p">,</span>
  <span class="nx">checkAuth</span>
<span class="p">};</span>
</code></pre></div>
<p>They are consumed by being “mounted” on an Express application (<code>app</code>) instance (in app.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="k">const</span> <span class="p">{</span> <span class="nx">logout</span><span class="p">,</span> <span class="nx">checkAuth</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./express-handlers.js&#39;</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">checkAuth</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">logout</span><span class="p">);</span>
</code></pre></div>
<p>For the above code to work in an integrated manner, we need to also <code>app.use</code> the <code>client-sessions</code> package like so. Note that the <code>cookieName</code> is important since it’s the property under which the session gets set on the <code>req</code> object.</p>

<p>We also add the <code>express.json</code> middleware (Express 4.16+), which works like body-parser’s <code>.json()</code> option ie. it parses JSON bodies and stores the output in to <code>req.body</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="k">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;client-sessions&#39;</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
  <span class="nx">secret</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_SECRET</span> <span class="o">||</span> <span class="s1">&#39;my-super-secret&#39;</span><span class="p">,</span>
  <span class="nx">cookieName</span><span class="o">:</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
  <span class="nx">duration</span><span class="o">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1">// 1 hour
</span><span class="c1"></span><span class="p">}));</span>

<span class="k">const</span> <span class="p">{</span> <span class="nx">logout</span><span class="p">,</span> <span class="nx">checkAuth</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./express-handlers.js&#39;</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">checkAuth</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">logout</span><span class="p">);</span>
</code></pre></div>
<h3 id="mocking-stubbing-req-a-simple-express-request-with-jest-or-sinon">Mocking/stubbing req (a simple Express request) with Jest or sinon</h3>

<p>A mockRequest function needs to return a request-compatible object, which is a plain JavaScript object, it could look like the following, depending on what properties of <code>req</code> the code under test is using. Our code only accesses <code>req.session.data</code>, it means it’s expecting <code>req</code> to have a <code>session</code> property which is an object so that it can attempt to access the <code>req.session.data</code> property.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">mockRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sessionData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">session</span><span class="o">:</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">sessionData</span> <span class="p">},</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>Since the above is just dealing with data, there’s no difference between mocking it in Jest or using sinon and the test runner of your choice (Mocha, AVA, tape, Jasmine…).</p>

<h3 id="mocking-stubbing-res-a-simple-express-response-with-jest">Mocking/stubbing res (a simple Express response) with Jest</h3>

<p>A mockResponse function would look like the following, our code under test only calls <code>status</code> and <code>json</code> functions. The issue we run into is that the calls are chained. This means that <code>status</code>, <code>json</code> and other <code>res</code> (Express response) methods return the <code>res</code> object itself.</p>

<p>That means that ideally our mock would behave in the same way:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">mockResponse</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">().</span><span class="nx">mockReturnValue</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">().</span><span class="nx">mockReturnValue</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>We’re leveraging <code>jest.fn</code>&rsquo;s <code>mockReturnValue</code> method to set the return value of both <code>status</code> and <code>json</code> to the mock response instance (<code>res</code>) they’re set on.</p>

<h3 id="mocking-stubbing-res-a-simple-express-response-with-sinon">Mocking/stubbing res (a simple Express response) with sinon</h3>

<p>The sinon equivalent to the above (with a similar explanation) follows. With sinon, we have to explicitly <code>require</code> it since it’s a standalone library (ie. not injected by test frameworks).</p>

<p>Sinon stubs have a <code>returns</code> method which behaves like the <code>mockReturnValue</code> Jest mock method. It sets the return value of the stub.</p>

<p>The <code>status</code> and <code>json</code> methods on our mock response instance (<code>res</code>) return the response instance (<code>res</code>) itself.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">sinon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sinon&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="nx">mockResponse</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">().</span><span class="nx">returns</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">().</span><span class="nx">returns</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="testing-a-handler-that-reads-from-req-and-sends-a-res-using-status-and-json">Testing a handler that reads from <code>req</code> and sends a <code>res</code> using status and json()</h3>

<p>The <code>checkAuth</code> handler reads from <code>req</code> and sends a <code>res</code> using <code>status()</code> and <code>json()</code>.</p>

<p>It contains the following logic, if <code>session.data</code> is not set, the session is not set, and therefore the user is not authenticated, therefore it sends a <code>401 Unauthorized</code> status with an empty JSON body.
Otherwise, it reflects the part of the session contents (just the <code>username</code>) in JSON response with a 200 status code.</p>

<p>Here’s the code under test (in express-handlers.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">username</span> <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>We need to test two paths: the one leading to a 401 and the other, leading to a 200.</p>

<p>See a snapshot of this code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/check-auth-tests">github.com/HugoDF/mock-express-request-response/releases/tag/check-auth-tests</a> (click on the commit sha for the diff for that version change).</p>

<p>Using the <code>mockRequest</code> and <code>mockResponse</code> we’ve defined before, we’ll set a request that has no session data (for 401) and does have session data containing username (for 200). Then we’ll check that <code>req.status</code> is called with 401 and 200 respectively. In the 200 case we’ll also check that <code>res.json</code> is called with the right payload (<code>{ username }</code>).</p>

<p>In Jest (see express-handlers.jest-test.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;checkAuth&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 401 if session data is not set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">();</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 200 with username from session if session data is set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>The same tests using sinon + AVA (in express-handlers.sinon-test.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;checkAuth &gt; should 401 if session data is not set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">();</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;checkAuth &gt; should 200 with username from session if data is set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">}));</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of this code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/check-auth-tests">github.com/HugoDF/mock-express-request-response/releases/tag/check-auth-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h3 id="testing-a-handler-that-writes-to-req-and-sends-a-res-using-status-and-json">Testing a handler that writes to  <code>req</code> and sends a <code>res</code> using status and json()</h3>

<p>The <code>logout</code> handler writes to req (it sets <code>req.session.data</code> to <code>null</code>) and sends a response using <code>res.status</code> and <code>res.json</code>. Here’s the code under test.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>It doesn’t have any branching logic, but we should test that <code>session.data</code> is reset and a response is sent in 2 separate tests. See a snapshot of this code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/logout-tests">github.com/HugoDF/mock-express-request-response/releases/tag/logout-tests</a> (click on the commit sha for the diff for that version change).</p>

<p>In Jest, with the <code>mockRequest</code> and <code>mockResponse</code> functions (in express-handlers.jest-test.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should set session.data to null&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBeNull</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 200&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>In AVA + sinon using mockRequest and mockResponse functions (in express-handlers.sinon-test.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;logout &gt; should set session.data to null&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;logout &gt; should 200&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">logout</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of this code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/logout-tests">github.com/HugoDF/mock-express-request-response/releases/tag/logout-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h2 id="a-complex-handler-request-response-mocking-scenario-a-request-to-login-with-a-body">A complex handler request/response mocking scenario: a request to login with a body</h2>

<p>Our login handler does the heaviest lifting in the application. It’s in <code>express-handlers.js</code> and containts the following logic.</p>

<p>The login handler first validates that the contents of <code>req.body</code> and 400s if either of them are missing (this will be our first 2 tests).</p>

<p>The login handler then attempts to <code>getUser</code> for the given username, if there is no such user, it 401s (this will be our 3rd test).</p>

<p>Next the login handler compares the password from the request with the hashed/salted version coming from <code>getUser</code> output, if that comparison fails, it 401s (this will be our 4th test).</p>

<p>Finally, if the username/password are valid for a user, the login handler sets session.data to <code>{ username }</code> and sends a 201 response (this will be our 5th test).</p>

<p>The final test (that I haven’t implemented) that would make sense is to check that the handler sends a 500 if an error occurs during its execution (eg. <code>getUser</code> throws).</p>

<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/login-tests">github.com/HugoDF/mock-express-request-response/releases/tag/login-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<p>The login functions is as follows, for readability’s sake, I’ve omitted <code>getUser</code>. <code>getUser</code> is implemented as a hard-coded array lookup in any case whereas in your application it will be a database or API call of some sort (unless you’re using oAuth).</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcrypt&#39;</span><span class="p">);</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;username and password are required&#39;</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;No user with matching username&#39;</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="kr">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">)))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Wrong password&#39;</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">};</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">json</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error during login of &#34;</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span><span class="sb">&#34;: </span><span class="si">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>It’s consumed, by being “mounted” on the Express app in <code>app.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/session&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="p">);</span>
</code></pre></div>
<p>To be able to test the login function we need to extends the <code>mockRequest</code> function, it’s still returning a plain JavaScript object so there is not difference between our Jest and AVA + sinon version:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">mockRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sessionData</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
  <span class="nx">session</span><span class="o">:</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">sessionData</span> <span class="p">},</span>
  <span class="nx">body</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/login-tests">github.com/HugoDF/mock-express-request-response/releases/tag/login-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h3 id="tests-for-login-handler-using-in-jest">Tests for login handler using in Jest</h3>

<blockquote>
<p><strong>Note:</strong> There’s a big wall of code incoming.</p>

<p>You can skip to the <a href="#tests-for-login-handler-using-ava-sinon">sinon + AVA version</a> if that’s what you’re interested in using <a href="#tests-for-login-handler-using-ava-sinon"><strong>this link</strong></a></p>

<p>Skip to the <a href="#testing-a-middleware-and-mocking-express-request-get-headers">Middleware and request.get headers</a> section using <a href="#testing-a-middleware-and-mocking-express-request-get-headers"><strong>this link.</strong></a></p>
</blockquote>

<p>To test this Express handler thoroughly is a few more tests but fundamentally the same principles as in the <code>checkAuth</code> and <code>logout</code> handlers.</p>

<p>The tests look like the following (in express-handlers.jest-test.js):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 400 if username is missing from body&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
      <span class="p">{},</span>
      <span class="p">{</span> <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;boss&#39;</span> <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;username and password are required&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 400 if password is missing from body&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
      <span class="p">{},</span>
      <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;username and password are required&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 401 with message if user with passed username does not exist&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
      <span class="p">{},</span>
      <span class="p">{</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo-boss&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;boss&#39;</span>
      <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;No user with matching username&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 401 with message if passed password does not match stored password&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
      <span class="p">{},</span>
      <span class="p">{</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;not-good-password&#39;</span>
      <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Wrong password&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 201 and set session.data with username if user exists and right password provided&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
      <span class="p">{},</span>
      <span class="p">{</span>
        <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;guest-boss&#39;</span>
      <span class="p">}</span>
    <span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span>
      <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/login-tests">github.com/HugoDF/mock-express-request-response/releases/tag/login-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h3 id="tests-for-login-handler-using-ava-sinon">Tests for login handler using AVA + sinon</h3>

<blockquote>
<p><strong>Note:</strong> There’s (another) big wall of code incoming.</p>

<p>You can go back to the <a href="#tests-for-login-handler-using-in-jest">Jest version</a> if that’s what you’re interested in using <a href="http://localhost:1313/express-request-response-mocking/#tests-for-login-handler-using-in-jest"><strong>this link</strong></a></p>

<p>Skip to the <a href="#testing-a-middleware-and-mocking-express-request-get-headers">Middleware and request.get headers</a> section using <a href="#testing-a-middleware-and-mocking-express-request-get-headers"><strong>this link.</strong></a></p>
</blockquote>

<p>Again there’s nothing fundamentally new in these tests, they’re just denser and closer to what you would do in a real-world application, they are as follows (in express-handlers.sinon-test.js):</p>

<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/login-tests">github.com/HugoDF/mock-express-request-response/releases/tag/login-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;login &gt; should 400 if username is missing from body&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="p">{</span> <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;boss&#39;</span> <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">400</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">({</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;username and password are required&#39;</span>
  <span class="p">}));</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 400 if password is missing from body&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">400</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">({</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;username and password are required&#39;</span>
  <span class="p">}));</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 401 with message if user with passed username does not exist&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="p">{</span>
      <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo-boss&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;boss&#39;</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">({</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;No user with matching username&#39;</span>
  <span class="p">}));</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 401 with message if passed password does not match stored password&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="p">{</span>
      <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;not-good-password&#39;</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">401</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">({</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Wrong password&#39;</span>
  <span class="p">}));</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should 201 and set session.data with username if user exists and right password provided&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span>
    <span class="p">{},</span>
    <span class="p">{</span>
      <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;guest-boss&#39;</span>
    <span class="p">}</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="mi">201</span><span class="p">));</span>
  <span class="nx">t</span><span class="p">.</span><span class="kc">true</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">called</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span> <span class="p">}</span>
  <span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/login-tests">github.com/HugoDF/mock-express-request-response/releases/tag/login-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h2 id="testing-a-middleware-and-mocking-express-request-get-headers">Testing a middleware and mocking Express request.get headers</h2>

<p>Another scenario in which you might want to mock/stub the Express request and response objects is when testing a middleware function.</p>

<p>Testing middleware is subtly different. A lot of middleware has conditions under which it does nothing (just calls <code>next()</code>). An Express middleware should always call <code>next()</code> (its 3rd parameter) or send a response.</p>

<p>Here’s an example middleware which allows authentication using an API key in an <code>Authorization</code> header of the format <code>Bearer {API_KEY}</code>.</p>

<p>Beyond the middleware vs handler differences, <code>headerAuth</code> is also using <code>req.get()</code>, which is used to get headers from the Express request.</p>

<p>I’ve omitted <code>apiKeyToUser</code> and <code>isApiKey</code>. <code>apiKeyToUser</code> is just a lookup from apiKeys to usernames. In a real-world application this would be a database lookup much like what would replace <code>getUser</code> in the <code>login</code> code.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">headerAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="nx">authenticationHeader</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">)</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">authenticationHeader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="nx">apiKey</span> <span class="o">=</span> <span class="nx">authenticationHeader</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Bearer&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isApiKey</span><span class="p">(</span><span class="nx">apiKey</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">apiKeyToUser</span><span class="p">[</span><span class="nx">apiKey</span><span class="p">]</span> <span class="p">};</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests">github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h3 id="updating-mockrequest-to-support-accessing-headers">Updating mockRequest to support accessing headers</h3>

<p>Here is a different version of mockRequest, it’s still a plain JavaScript object, and it mock <code>req.get</code> just enough to get the tests passing:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">mockRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">authHeader</span><span class="p">,</span> <span class="nx">sessionData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">({</span>
  <span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;authorization&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">authHeader</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="p">},</span>
  <span class="nx">session</span><span class="o">:</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">sessionData</span> <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="testing-a-middleware-that-accesses-headers-with-jest">Testing a middleware that accesses headers with Jest</h3>

<p>Most of the tests check that nothing changes on the session while the middleware executes since it has a lot of short-circuit conditions.</p>

<p>Note how we pass a no-op function <code>() =&gt; {}</code> as the 3rd parameter (which is <code>next</code>).</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;headerAuthMiddleware&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should set req.session.data if API key is in authorization and is valid&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;76b1e728-1c14-43f9-aa06-6de5cbc064c2&#39;</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if req.session.data is already set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;76b1e728-1c14-43f9-aa06-6de5cbc064c2&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span> <span class="p">});</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span> <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if authorization header is not present&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBeUndefined</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if api key is invalid&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;invalid-api-key&#39;</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
    <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBeUndefined</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests">github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h3 id="testing-a-middleware-that-accesses-headers-using-ava-sinon">Testing a middleware that accesses headers using AVA + sinon</h3>

<p>Most of the tests check that nothing changes on the session while the middleware executes since it has a lot of short-circuit conditions.</p>

<p>Note how we pass a no-op function <code>() =&gt; {}</code> as the 3rd parameter (which is <code>next</code>).</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should set req.session.data if API key is in authorization and is valid&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;76b1e728-1c14-43f9-aa06-6de5cbc064c2&#39;</span><span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;hugo&#39;</span> <span class="p">}</span>
  <span class="p">);</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if req.session.data is already set&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;76b1e728-1c14-43f9-aa06-6de5cbc064c2&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span> <span class="p">});</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
    <span class="p">{</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;guest&#39;</span> <span class="p">}</span>
  <span class="p">);</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if authorization header is not present&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;should not do anything if api key is invalid&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">mockRequest</span><span class="p">(</span><span class="s1">&#39;invalid-api-key&#39;</span><span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">mockResponse</span><span class="p">();</span>
  <span class="kr">await</span> <span class="nx">headerAuthMiddleware</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{});</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<blockquote>
<p>See a snapshot of the code on GitHub <a href="https://github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests">github.com/HugoDF/mock-express-request-response/releases/tag/middleware-header-tests</a> (click on the commit sha for the diff for that version change).</p>
</blockquote>

<h2 id="keys-to-testing-express-handlers-and-middleware">Keys to testing Express handlers and middleware</h2>

<p>There are a few keys to testing Express effectively in the manner outlined in this post.</p>

<p>First of all is understanding what the code does. It’s harder than it seems. Testing in JavaScript is a lot about understanding JavaScript, a bit about testing tools and a bit understanding the tools used in that application under test. In order to mock the tool’s return values with the right type of data.</p>

<p>All the tests in the post boil down to understanding what <code>req</code>, <code>res</code> and <code>next</code> are (an object, an object and a function). Which properties they have/can have, how those properties are used and whether they’re a function or an object.</p>

<p>This is only 1 approach to testing Express handlers and middleware. The alternative is to fire up the Express server (ideally in-memory using SuperTest). I go into more detail on how to achieve that in <a href="https://codewithhugo.com/testing-an-express-app-with-supertest-moxios-and-jest/">“Testing an Express app with SuperTest, moxios and Jest”</a></p>

<p><a style="background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, Helvetica, Ubuntu, Roboto, Noto, &quot;Segoe UI&quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px" href="https://unsplash.com/@cbarbalis?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge" target="_blank" rel="noopener noreferrer" title="Download free do whatever you want high-resolution photos from Chris Barbalis"><span style="display:inline-block;padding:2px 3px"><svg xmlns="http://www.w3.org/2000/svg" style="height:12px;width:auto;position:relative;vertical-align:middle;top:-2px;fill:white" viewBox="0 0 32 32"><title>unsplash-logo</title><path d="M10 9V0h12v9H10zm12 5h10v18H0V14h10v9h12v-9z"></path></svg></span><span style="display:inline-block;padding:2px 3px">Chris Barbalis</span></a></p>
    </div>
  </section>

  <section class="subscribe-form">
    <h3 class="subscribe-form-title">Subscribe to Code with Hugo</h3>
    <p>Get all the posts of the week before anyone else in your inbox</p>
    <form action="https://buttondown.email/api/emails/embed-subscribe/hugo" method="post" target="popupwindow"
      onsubmit="window.open('https://buttondown.email/hugo', 'popupwindow')">
      <div class="form-group">
        <input class="subscribe-email" type="email" name="email" id="bd-email" placeholder="youremail@example.com">
        <input type="hidden" value="1" name="embed" />
      </div>
      <button class="" value="Subscribe" type="submit"><span>Subscribe</span></button>
    </form>
  </section>

  <footer class="post-full-footer">
    <section class="author-card">
      <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg"
        alt="Author" />
      <section class="author-card-content">
        <h4 class="author-card-name"><a href="https://codewithhugo.com/">Hugo Di Francesco</a>
        </h4>
        <p>A developer, working out of London writing CSS, JavaScript and Python.</p>
      </section>
    </section>
  </footer>
</article>


  <section class="overlay-cta">
    <div class="overlay-cta__inner">
      <div class="overlay-cta__text-container">
        <h3 class="cta-title overlay-cta__title">
          Subscribe for Enterprise Node.js and JavaScript Guides
        </h3>
        <p class="cta-text overlay-cta__text">
          Build your web platform with modern Node.js/JavaScript best-practices, tools and patterns
        </p>
      </div>
      <div class="overlay-cta__button-container">
        <a href="https://buttondown.email/hugo" class="button overlay-cta__button">
          I want this
        </a>
        <a href="#" class="overlay-cta__close">close</a>
      </div>
    </div>
  </section>



    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      
<article class="read-next-card" 
            style="background-image: url(https://codewithhugo.com/img/cover.jpg);" >
    <header class="read-next-card-header">
        <small class="read-next-card-header-sitetitle">&mdash; Code with Hugo &mdash;</small>
        
        <h3 class="read-next-card-header-title"><a href="https://codewithhugo.com/tags/node/">#Node</a></h3>
    </header>
    <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
    </div>

    <div class="read-next-card-content">
      
        <ul>
          <li><a href="https://codewithhugo.com/ava-low-config-testing-for-javascript/">AVA, low-config testing for JavaScript</a></li>            
        
          <li><a href="https://codewithhugo.com/how-to-make-beautiful-simple-cli-apps-with-node/">How to make beautiful, simple CLI apps with Node</a></li>            
        
          <li><a href="https://codewithhugo.com/connect-to-mongodb-on-dokku-with-your-local-command-line-or-robo3t/">Connect to MongoDB on Dokku with your local command line or Robo3T</a></li>            
        
          <li><a href="https://codewithhugo.com/sequelize-data-types-a-practical-guide/">Sequelize Data Types: a practical guide</a></li>            
        </ul>
    </div>
    <footer class="read-next-card-footer">
      
        <a href="https://codewithhugo.com/tags/node/">See all related posts →</a>
    </footer>
</article>


      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/parse-express-json-body/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/mahir-uysal-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/parse-express-json-body/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Node 
              #Express 
              #JavaScript  </span>
              
              <h2 class="post-card-title">Parse POST/PATCH/PUT request JSON body with Express and no dependencies</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>When asked to handle data in a request body, developers who have used Express (the “Fast, unopinionated, minimalist web framework for Node.js”) before, reach for the body-parser library.
The same functionality can be achieved using express.json(). A middleware for parsing JSON request bodies built-into Express.
 Note: express.json exists only in Express 4.16+
 
 ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/node-configuration-management/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/filip-gielda-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/node-configuration-management/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Node 
              #JavaScript 
              #deployment  </span>
              
              <h2 class="post-card-title">12-factor Node.js application configuration management without the `config` npm package</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>The config npm package is great (npmjs.com/package/config), but it encourages confusing and non-12-factor-app-compliant patterns.
We’ll look at some of the patterns it encourages and why they’ll bring you struggles down the road as well a simple, single-file, no-dependency way to define your configuration.  ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <div class="floating-header-logo">
    <a href="https://codewithhugo.com/">
      
      <span>Code with Hugo</span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">A guide to Express request and response mocking/stubbing with Jest or sinon</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/></svg>
    </div>

    
    <a class="floating-header-share-tw" href="https://twitter.com/share?text=%22A%20guide%20to%20Express%20request%20and%20response%20mocking%2fstubbing%20with%20Jest%20or%20sinon%22%20by%20%40hugo__df&amp;url=https%3a%2f%2fcodewithhugo.com%2fexpress-request-response-mocking%2f&amp"
          onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
      </a>
      <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcodewithhugo.com%2fexpress-request-response-mocking%2f"
          onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
      </a>
  </div>

  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/">Code with Hugo</a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        <a href="https://twitter.com/hugo__df" target="_blank" rel="noopener">Twitter</a>
        <a href="https://github.com/HugoDF" target="_blank" rel="noopener">Github</a>
        
        <a href="https://medium.com/@hugo__df" target="_blank" rel="noopener">Medium</a>
    </nav>  
  </div>
</footer>

</div>

<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://codewithhugo.com/js/jquery.fitvids.js"></script>




  <!-- Google Analytics -->
  <script>
    var _gaq=[['_setAccount','UA-60469708-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>




<script>
  (function (window) {
    function displayAmaAd() {
      document.querySelector('#codefund_ad').innerHTML = `<span>
        <div class="cf-wrapper">
          <div class="cf-header">Proudly sponsored by</div>
          <a href="https://checkoutpage.co/checkout/hugo/consulting-fee" class="cf-text">
            <strong>Ask Hugo anything</strong><br />
            Get in touch, I'm available for development, career or any other type of questions
          </a>


          <a href="/" class="cf-powered-by">
            <em>useful</em> products by Code with Hugo
          </a>
        </div>
      </span>`
    }

    window.addEventListener("codefund", function(evt) {
      if (evt.detail.status !== 'ok') {
        displayAmaAd();
      }
    });

  })(window);
</script>


<script async defer src="https://infra.codewithhugo.com/app.js"></script>
<noscript><img src="https://infra.codewithhugo.com/image.gif" alt=""></noscript>





<script>
  (function (document) {
    function getLastDocumentHeight(document) {
      var body = document.body;
      var html = document.documentElement;
      return Math.max(
        body.scrollHeight, body.offsetHeight,
        html.clientHeight, html.scrollHeight,
        html.offsetHeight
      );
    }

    var $overlay = document.querySelector('.overlay-cta');
    var hiddenClass = 'overlay-cta--hidden';
    var closedClass = 'overlay-cta--closed';
    $overlay.classList.add(hiddenClass);

    
    var $overlayClose = document.querySelector('.overlay-cta__close');
    var overlayCloseListener = $overlayClose.addEventListener('click', function (e) {
      e.preventDefault();
      $overlay.classList.add(closedClass);
    });

    var $heroCtaButton = document.querySelector('.hero-cta .button');
    var $firstContentItem = document.querySelector('.post-full-content > * > *');
    var title = $heroCtaButton || $firstContentItem;

    var $subscribeBox = document.querySelector('.subscribe-form');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = getLastDocumentHeight(document);
    var ticking = false;


    function onScroll() {
      lastScrollY = window.scrollY;
      requestTick();
    }

    function onResize() {
      lastWindowHeight = window.innerHeight;
      lastDocumentHeight = getLastDocumentHeight(document);
      requestTick();
    }

    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(update);
      }
      ticking = true;
    }

    function update() {
      var trigger = title.getBoundingClientRect().top + window.scrollY;
      var triggerOffset = title.offsetHeight + 35;
      var lastShowCtaBoxHeight = $subscribeBox.getBoundingClientRect().top ;
      
      if (
        lastScrollY >= trigger + triggerOffset &&
        lastShowCtaBoxHeight > lastWindowHeight
      ) {
        $overlay.classList.remove(hiddenClass);
      } else {
        $overlay.classList.add(hiddenClass);
      }

      ticking = false;
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize, false);

    update();
  })(document);
</script>


    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
