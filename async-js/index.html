<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="gBfbdXRLofaOyHsbgiSiuCIHKPaviGMRVWh_qOfDHNE" />

    <title>Async JavaScript: history, patterns and gotchas &middot; Code with Hugo</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#090a0b">

    <link rel="shortcut icon" href="https://codewithhugo.com/favicon.ico" />
    <meta name="theme-color" content="#090a0b">
    
    <link rel="canonical" href="https://codewithhugo.com/async-js/" /> 

     <meta name="description" content="&lt;p&gt;A look at the history, patterns and gotchas of asynchronous operations in JavaScript.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll go through the pros and cons of callbacks, Promises" /> 

     
    
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://codewithhugo.com/img/async-js-cover.jpg"/>
    
 
    <meta name="twitter:title" content="Async JavaScript: history, patterns and gotchas"/>
    <meta name="twitter:description" content="&lt;p&gt;A look at the history, patterns and gotchas of asynchronous operations in JavaScript.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll go through the pros and cons of callbacks, Promises"/>
    <meta name="twitter:url" content="https://codewithhugo.com/async-js" />
    <meta name="twitter:site" content="@hugo__df"/>

    <meta property="og:site_name" content="Code with Hugo" />
    <meta property="og:title" content="Async JavaScript: history, patterns and gotchas &middot; Code with Hugo" />
    <meta property="og:url" content="https://codewithhugo.com/async-js/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="&lt;p&gt;A look at the history, patterns and gotchas of asynchronous operations in JavaScript.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;ll go through the pros and cons of callbacks, Promises" />

    <meta property="article:published_time" content="2019-01-28T00:00:00Z" />
    <meta property="article:tag" content="JavaScript" /><meta property="article:tag" content="Node" />

    <meta property="og:image" content="https://codewithhugo.com/img/async-js-cover.jpg"/>


    <meta name="generator" content="Hugo 0.46" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/css/casper-two.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/overrides.min.bd35cf74c58c56c4aa8eff40730357744dec20ff31d8bae7b0618dbe30e0dbe4.css">
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/syntax.min.e1646a3f88f77e1b5e7d0253633b1958013aa132890dfe4d7e15dc4718d4aecc.css">
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/cta.min.612120dbcad38a206f6cc18996cd1f7d45141911bf04c86ab0c6132a55274b7b.css">
    

    

     
</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/">Categories</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/guides/">guides</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/javascript/">JavaScript</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/node/">Node</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/sequelize/">Sequelize</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/deployment/">Deployment</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/open/">#open</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="https://checkoutpage.co/checkout/hugo/consulting-fee">#AMA</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    <a class="social-link social-link-tw" href="https://twitter.com/hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg></a>

                    <a class="social-link" href="https://github.com/HugoDF" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    <a class="social-link" href="https://medium.com/@hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 195 195"><path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z"/></svg></a>
        </div>  
        
        <a class="subscribe-button" href="https://codewithhugo.com/index.xml">Subscribe</a>
            
      </div>

    </nav>  

  </div>
</header>

<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      
<div id="codefund_ad"></div>


<article class="post-full post">
    <header class="post-full-header">
        <section class="post-full-meta">
            <time class="post-full-meta-date" datetime="2019-01-28">28 January 2019</time>
                <span class="date-divider">/</span> <a href="https://codewithhugo.com/tags/javascript/">#JavaScript</a>&nbsp;<a href="https://codewithhugo.com/tags/node/">#Node</a>&nbsp;
        </section>
        <h1 class="post-full-title">Async JavaScript: history, patterns and gotchas</h1>
    </header>
    <div class="hero-container">

      
      <figure class="post-full-image" style="background-image: url(https://codewithhugo.com/img/async-js-cover.jpg)">
        

      </figure>
    </div>

    <section class="post-full-content">
        <div class="kg-card-markdown">
        <p>A look at the history, patterns and gotchas of asynchronous operations in JavaScript.</p>

<p>We&rsquo;ll go through the pros and cons of callbacks, Promises and async/await. Present some pitfalls to bear in mind as well as introducing how you would deal with certain situations.</p>

<p>Live-coding/workshop section touching on both Node and client-side JS situations at <a href="https://github.com/HugoDF/async-js-presentation/tree/master/workshop">github.com/HugoDF/async-js-presentation/tree/master/workshop</a>.</p>

<p></p>

<p>This given as a talk at Codebar London January Monthly 2019, see the slides:</p>

<div style="width: 100%; padding: 50px;">
    <!-- SpeakderDeck embed -->
    <script async class="speakerdeck-embed" data-id="bdf4eba915de465096eecc8322c7f712" data-ratio="1.41436464088398" src="https://speakerdeck.com/assets/embed.js"></script>
</div>

<p><strong>Table of Contents 🐳</strong>:</p>

<ul>
<li><a href="#asynchronicity-in-javascript">Asynchronicity in JavaScript</a>

<ul>
<li><a href="#what-s-asynchronous-in-a-web-application">What&rsquo;s asynchronous in a web application?</a></li>
<li><a href="#why-non-blocking-i-o">Why non-blocking I/O?</a></li>
</ul></li>
<li><a href="#node-style-callbacks">Node-style callbacks</a>

<ul>
<li><a href="#node-style-callbacks-problems">Node-style callbacks: problems</a></li>
<li><a href="#1-callback-hell">1. Callback <em>hell</em></a></li>
<li><a href="#2-shadowing-variables">2. Shadowing variables</a></li>
<li><a href="#3-duplicated-error-handling">3. Duplicated error handling</a></li>
<li><a href="#4-swallowed-errors">4. Swallowed errors</a></li>
<li><a href="#callback-problems">Callback problems</a></li>
</ul></li>
<li><a href="#bring-on-the-promise">Bring on the Promise</a>

<ul>
<li><a href="#pros">Pros</a></li>
<li><a href="#cons">Cons</a></li>
<li><a href="#promise-gotchas">Promise gotchas</a></li>
<li><a href="#nesting-them-is-tempting">Nesting them is tempting</a></li>
<li><a href="#onrejected-callback">onRejected callback</a></li>
</ul></li>
<li><a href="#async-await">async/await</a>

<ul>
<li><a href="#example-loop-through-sequential-calls">Example: loop through sequential calls</a></li>
<li><a href="#example-share-data-between-calls">Example: share data between calls</a></li>
<li><a href="#example-error-handling">Example: error handling</a></li>
<li><a href="#cons-of-async-await">Cons of async/await</a></li>
</ul></li>
<li><a href="#gotchas">Gotchas</a>

<ul>
<li><a href="#creating-an-error">Creating an error</a></li>
<li><a href="#what-happens-when-you-forget-await">What happens when you forget await?</a></li>
<li><a href="#promises-evaluate-eagerly">Promises evaluate eagerly ✨</a></li>
<li><a href="#testing-gotchas">Testing gotchas 📙</a></li>
</ul></li>
<li><a href="#patterns">Patterns</a>

<ul>
<li><a href="#running-promises-in-parallel">Running promises in parallel 🏃</a></li>
<li><a href="#delay-execution-of-a-promise">Delay execution of a promise</a></li>
<li><a href="#separate-synchronous-and-asynchronous-operations">Separate synchronous and asynchronous operations</a></li>
<li><a href="#running-promises-sequentially">Running promises sequentially</a></li>
<li><a href="#passing-data-in-sequential-async-calls">Passing data in sequential async calls</a></li>
<li><a href="#error-handling">Error handling</a></li>
</ul></li>
<li><a href="#workshop-examples">Workshop Examples</a>

<ul>
<li><a href="#callbackify-ing-a-promise-based-api">&ldquo;callbackify&rdquo;-ing a Promise-based API</a></li>
<li><a href="#getting-data-in-parallel-using-callbacks-the-pain">Getting data in parallel using callbacks: the pain</a></li>
<li><a href="#promisify-ing-a-callback-based-api">&ldquo;promisify&rdquo;-ing a callback-based API</a></li>
<li><a href="#why-we-don-t-mix-async-and-sync-operations">Why we don&rsquo;t mix async and sync operations</a></li>
</ul></li>
<li><a href="#further-reading">Further Reading</a></li>
</ul>

<h2 id="asynchronicity-in-javascript">Asynchronicity in JavaScript</h2>

<p>Primitives:</p>

<ul>
<li>Callbacks</li>
<li>Promises</li>
<li>Observables (not covered in this post)</li>
<li><code>async/await</code></li>
</ul>

<h3 id="what-s-asynchronous-in-a-web-application">What&rsquo;s asynchronous in a web application?</h3>

<p>Most things:</p>

<ol>
<li>any network calls (HTTP, database)</li>
<li>timers (<code>setTimeout</code>, <code>setInterval</code>)</li>
<li>filesystem access</li>
</ol>

<p>&hellip; Anything else that can be offloaded</p>

<p>In JavaScript, these operations are non-blocking.</p>

<p>HTTP Request in Python:</p>
<div class="highlight"><pre class="chroma"><code class="language-py" data-lang="py"><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">myUrl</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code></pre></div>
<p>HTTP Request in JavaScript:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">request</span><span class="p">(</span><span class="nx">myUrl</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="why-non-blocking-i-o">Why non-blocking I/O?</h3>

<p>JavaScript was conceived as a UI programming language. In UI, you don&rsquo;t want to freeze UI interactions while you wait for a server to respond for example.</p>

<p>Non-blocking I/O means waiting doesn&rsquo;t cost you compute cycles.</p>

<p>How non-blocking I/O is implemented (in JavaScript):</p>

<ul>
<li>pass a &ldquo;callback&rdquo; function</li>
<li>it&rsquo;s called with the outcome of the async operation</li>
</ul>

<h2 id="node-style-callbacks">Node-style callbacks</h2>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">dealWithIt</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="nx">doSomethingWith</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div>
<p>A callback is:</p>

<ul>
<li>&ldquo;just&rdquo; a function</li>
<li>in examples, usually anonymous functions (pass <code>function () {}</code> directly)</li>
<li>according to some style guides, should be an arrow function (<code>() =&gt; {}</code>)</li>
<li>called when the async operation</li>
</ul>

<p>A Node-style callback is:</p>

<ul>
<li>called with any error(s) as the first argument/parameter, if there&rsquo;s no error, <code>null</code> is passed</li>
<li>called with any number of &ldquo;output&rdquo; data as the other arguments</li>
</ul>

<p>ie. <code>(err, data) =&gt; { /* more logic */ }</code></p>

<h3 id="node-style-callbacks-problems">Node-style callbacks: problems</h3>

<h4 id="1-callback-hell">1. Callback <em>hell</em></h4>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>For each asynchronous operation:</p>

<ul>
<li>extra level of indent</li>
<li>lots of names for async output: <code>data</code>, <code>secondData</code></li>
</ul>

<h4 id="2-shadowing-variables">2. Shadowing variables</h4>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<ul>
<li><code>err</code> (in <code>myAsyncFn</code> callback) !== <code>err</code> (in <code>myOtherAsyncFn</code> callback) despite having the same nam</li>
</ul>

<h4 id="3-duplicated-error-handling">3. Duplicated error handling</h4>

<ul>
<li>1 call to <code>handle(err)</code> per operation</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h4 id="4-swallowed-errors">4. Swallowed errors</h4>

<p>Ideal failure:</p>

<ul>
<li>fail early</li>
<li>fail fast</li>
<li>fail loud</li>
</ul>

<p>Spot the unhandled error:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>The <strong>silent error</strong> is where the comment is.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Missing error handling!
</span><span class="c1"></span>    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<p>That <code>err</code> doesn&rsquo;t get handled. Linters would have caught that (I hope), whining that <code>err</code> was defined but not used. That&rsquo;s living on the edge a little bit.</p>

<h3 id="callback-problems">Callback problems</h3>

<p>The issues with callbacks boil down to the following.</p>

<p><strong>Callback hell</strong> with its many indents and variable names.</p>

<p><strong>Shadowed variables</strong> with all the issues that brings.</p>

<p><strong>Duplicated error-handling</strong> which makes it easy to <strong>swallow errors</strong>.</p>

<h2 id="bring-on-the-promise">Bring on the Promise</h2>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">data</span><span class="p">,</span>
    <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
  <span class="p">]))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
  <span class="p">]))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="cm">/* do anything else */</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
</code></pre></div>
<h3 id="pros">Pros</h3>

<p>Promises are <strong>chainable</strong>, you can return a Promise from <code>.then</code>, tack another <code>.then</code> and keep it going, no crazy indent stuff.</p>

<p>You can define a <strong>single error handler</strong> using <code>.catch</code> added to the end of your promise chain.</p>

<p>One small function per async step (inside <code>.then</code>) makes it easier to break down long asynchronous flows.</p>

<h3 id="cons">Cons</h3>

<p>You define a lot of tightly scoped functions, passing data from one call to the next is <strong>very verbose</strong> eg.:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="nx">data</span><span class="p">,</span>
  <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
<span class="p">])</span>
</code></pre></div>
<h3 id="promise-gotchas">Promise gotchas</h3>

<h4 id="nesting-them-is-tempting">Nesting them is tempting</h4>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
        <span class="p">([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">])</span> <span class="p">=&gt;</span>
          <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
            <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
            <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
          <span class="p">])</span>
      <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</code></pre></div>
<p>Solution: Avoid the Pyramid of Doom ☠️</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">data</span><span class="p">,</span>
    <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
  <span class="p">]))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
  <span class="p">]))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="cm">/* do anything else */</span><span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</code></pre></div>
<p>Promises &ldquo;flatten&rdquo;, you can return a Promise from a <code>then</code> and keep adding <code>.then</code> that expects the resolved value.</p>

<h3 id="onrejected-callback">onRejected callback</h3>

<p><code>.then</code> takes two parameters, <code>onResolved</code> and <code>onRejected</code>, so the following works:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
    <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">);</span>
</code></pre></div>
<p>But we&rsquo;re back to doing per-operation error-handling like in callbacks (potentially swallowing errors etc.)</p>

<p>Solution: avoid it, in favour of <code>.catch</code></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">myAsyncFn</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
</code></pre></div>
<p><em>Unless you specifically need it</em>, eg. when you use <code>redux-thunk</code> and making HTTP calls, you also <code>.catch</code> rendering errors from React.</p>

<p>In that case, it&rsquo;s preferrable to use <code>onRejected</code>.</p>

<h2 id="async-await">async/await</h2>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">myAsyncFn</span><span class="p">();</span>
    <span class="k">const</span> <span class="nx">secondData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">const</span> <span class="kr">final</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
      <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
    <span class="p">]);</span>
    <span class="cm">/* do anything else */</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})();</span>
</code></pre></div>
<p>Given a Promise (or any object that has a <code>.then</code> function), <code>await</code> takes the value passed to the callback in <code>.then</code>.</p>

<p><code>await</code> can only be used inside a function that is <code>async</code>.
Top-level (outside of async function) await is coming, currently you&rsquo;ll get a syntax error though.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Immediately invoked function expressions (IIFEs) are cool again&#39;</span><span class="p">)</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://jsonplaceholder.typicode.com/todos/2&#39;</span><span class="p">)</span>
  <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})()</span>

<span class="c1">// SyntaxError: await is only valid in async function
</span><span class="c1"></span><span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span>
  <span class="s1">&#39;https://jsonplaceholder.typicode.com/todos/2&#39;</span>
<span class="p">)</span>
</code></pre></div>
<p><code>async</code> functions are &ldquo;just&rdquo; Promises. Which means you can call an <code>async</code> function and tack a <code>.then</code> onto it.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">arrow</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span> <span class="p">}</span>
<span class="k">const</span> <span class="nx">implicitReturnArrow</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="mi">1</span>
<span class="k">const</span> <span class="nx">anonymous</span> <span class="o">=</span> <span class="kr">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span> <span class="p">}</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">expression</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span> <span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arrow</span><span class="p">());</span> <span class="c1">// Promise { 1 }
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">implicitReturnArrow</span><span class="p">());</span> <span class="c1">// Promise { 1 }
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">anonymous</span><span class="p">());</span> <span class="c1">// Promise { 1 }
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">expression</span><span class="p">());</span> <span class="c1">// Promise { 1 }
</span><span class="c1"></span></code></pre></div>
<h3 id="example-loop-through-sequential-calls">Example: loop through sequential calls</h3>

<p>With async/await:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">fetchSequentially</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="nx">url</span> <span class="k">of</span> <span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>With promises:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">fetchSequentially</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="p">[</span> <span class="nx">url</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">urls</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">text</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)))</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">fetchSequentially</span><span class="p">(</span><span class="nx">rest</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="example-share-data-between-calls">Example: share data between calls</h3>

<p><code>const myVariable = await fetchThing()</code> -&gt; easy</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">myAsyncFn</span><span class="p">();</span>
  <span class="k">const</span> <span class="nx">secondData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">myOtherAsyncFn</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">const</span> <span class="kr">final</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">fun</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">secondData</span><span class="p">),</span>
  <span class="p">]);</span>

  <span class="k">return</span> <span class="kr">final</span>
<span class="p">}</span>
</code></pre></div>
<p>We don&rsquo;t have the whole Promise-flow of:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">dataToPass</span><span class="p">,</span> <span class="nx">promiseThing</span><span class="p">]))</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">data</span><span class="p">,</span> <span class="nx">promiseOutput</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">})</span>
</code></pre></div>
<h3 id="example-error-handling">Example: error handling</h3>

<p>In the following example, the <code>try/catch</code> gets any error and logs it.</p>

<p>The caller of the function has no idea anything failed.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">withErrorHandling</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">withErrorHandling</span><span class="p">(</span>
  <span class="s1">&#39;https://jsonplaceholer.typicode.com/todos/2&#39;</span>
  <span class="c1">// The domain should be jsonplaceholder.typicode.com
</span><span class="c1"></span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="cm">/* but we&#39;ll end up here */</span> <span class="p">})</span>
</code></pre></div>
<h3 id="cons-of-async-await">Cons of async/await</h3>

<p>Browser support is only good in latest/modern browsers.</p>

<p>Polyfills (async-to-gen, regenerator runtime) are big, so sticking to Promises if you&rsquo;re only using async/await for syntactic sugar is a good idea.</p>

<p>Node 8+ supports it natively though, no plugins, no transpilation, no polyfills, so async/await away there.</p>

<p>Keen functional programming people would say it leads to a more &ldquo;imperative&rdquo; style of programming, I don&rsquo;t like indents so I don&rsquo;t listen to that argument.</p>

<h2 id="gotchas">Gotchas</h2>

<h3 id="creating-an-error">Creating an error</h3>

<p><code>throw</code>-ing inside an <code>async</code> function and <code>return Promise.reject</code> work the same</p>

<p><code>.reject</code> and <code>throw</code> <code>Error</code> objects please, you never know which library might do an <code>instanceof Error</code> check.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">asyncThrow</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;asyncThrow&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">rejects</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;rejects&#39;</span><span class="p">))</span>
<span class="p">}</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">swallowError</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span> <span class="kr">await</span> <span class="nx">asyncThrow</span><span class="p">()</span> <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span> <span class="kr">await</span> <span class="nx">rejects</span><span class="p">()</span> <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
<span class="nx">swallowError</span><span class="p">()</span> <span class="c1">// asyncThrow Error {} rejects Error {}
</span><span class="c1"></span></code></pre></div>
<h3 id="what-happens-when-you-forget-await">What happens when you forget await?</h3>

<p>Values are undefined, Promise is an object that has few properties.</p>

<p>You&rsquo;ll often see: <code>TypeError: x.fn is not a function</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">forgotToWait</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://jsonplaceholer.typicode.com/todos/2&#39;</span><span class="p">)</span>
    <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">forgotToWait</span><span class="p">()</span>
<span class="c1">// TypeError: res.text is not a function
</span><span class="c1"></span></code></pre></div>
<p>The <code>console.log</code> output of Promise/async function (which is just a Promise) is: <code>Promise { &lt;pending&gt; }</code>.</p>

<p>When you start debugging your application and a variable that was supposed to contain a value logs like that, you probably forgot an <code>await</code> somewhere.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">forgotToWait</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://jsonplaceholer.typicode.com/todos/2&#39;</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">forgotToWait</span><span class="p">()</span>
<span class="c1">// Promise { &lt;pending&gt; }
</span><span class="c1"></span></code></pre></div>
<h3 id="promises-evaluate-eagerly">Promises evaluate eagerly ✨</h3>

<p>Promises don&rsquo;t wait for anything to execute, when you create it, it runs:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;eeeeager&#39;</span><span class="p">);</span>
  <span class="nx">resolve</span><span class="p">();</span>
<span class="p">})</span>
</code></pre></div>
<p>The above code will immediately print &lsquo;eeeeager&rsquo;, tip: don&rsquo;t create Promises you don&rsquo;t want to run.</p>

<h3 id="testing-gotchas">Testing gotchas 📙</h3>

<p>Jest supports Promises as test output (therefore also <code>async</code> functions):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">runCodeUnderTest</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">test</span><span class="p">(</span><span class="s1">&#39;it should pass&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">doSomeSetup</span><span class="p">();</span>

  <span class="kr">await</span> <span class="nx">runCodeUnderTest</span><span class="p">();</span>
  <span class="c1">// the following never gets run
</span><span class="c1"></span>  <span class="nx">doSomeCleanup</span><span class="p">();</span>
<span class="p">})</span>
</code></pre></div>
<p>If you test fails, the <code>doSomeCleanup</code> function doesn&rsquo;t get called so you might get cascading failures.</p>

<p>Do your cleanup in &ldquo;before/after&rdquo; hooks, async test bodies crash and don&rsquo;t clean up.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">doSomeSetup</span><span class="p">())</span>
  <span class="nx">afterEach</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">doSomeCleanup</span><span class="p">())</span>
  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;it should pass&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nx">runCodeUnderTest</span><span class="p">();</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h2 id="patterns">Patterns</h2>

<p>A lot of these are to avoid the pitfalls we&rsquo;ve looked in the &ldquo;gotchas&rdquo; section.</p>

<h3 id="running-promises-in-parallel">Running promises in parallel 🏃</h3>

<p>Using <code>Promise.all</code>, which expects an array of Promises, waits until they all resolve (complete) and calls <code>.then</code> handler with the array of resolved values.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">fetchParallel</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
    <span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
      <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span>
      <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
    <span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Using <code>Promise.all</code> + <code>map</code> over an <code>async</code> function, an async function is&hellip; &ldquo;just a Promise&rdquo;.</p>

<p>Good for logging or when you&rsquo;ve got non-trivial/business logic</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">fetchParallel</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
    <span class="nx">urls</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
      <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="delay-execution-of-a-promise">Delay execution of a promise</h3>

<p>Promises are eager, they just wanna run! To delay them, wrap them in a function that returns the Promise.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">getX</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// or
</span><span class="c1"></span>
<span class="k">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="nx">url</span> <span class="p">=&gt;</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</code></pre></div>
<p>No Promise, no eager execution. Fancy people would call the above &ldquo;thunk&rdquo;, which is a pattern to delay execution/calculation.</p>

<h3 id="separate-synchronous-and-asynchronous-operations">Separate synchronous and asynchronous operations</h3>

<p>A flow in a lot of web applications that rely on asynchronous operations for read and write is the following.</p>

<p>Fetch data, doing an asynchronous operation. Run synchronous operations using the data in-memory. Write the data back with an asynchronous call.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">promises</span>

<span class="k">const</span> <span class="nx">fetchFile</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">replaceAllThings</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">=&gt;</span>
  <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/a/g</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="nx">writeFile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">=&gt;</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>

<span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetchFile</span><span class="p">();</span>
  <span class="k">const</span> <span class="nx">newText</span> <span class="o">=</span> <span class="nx">replaceAllThings</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="kr">await</span> <span class="nx">writeFile</span><span class="p">(</span><span class="nx">newText</span><span class="p">);</span>
<span class="p">})();</span>
</code></pre></div>
<p>A lot of built-in functions don&rsquo;t wait for a Promise to resolve. If you mix string manipulation/replacement and Promises you&rsquo;ll end up with <code>[object Promise]</code> everywhere your code injected the Promise object instead of the resolved value.</p>

<h3 id="running-promises-sequentially">Running promises sequentially</h3>

<p>Using recursion + rest/spread and way too much bookkeeping&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">fetchSequentially</span><span class="p">(</span><span class="nx">urls</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">urls</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">data</span>
  <span class="k">const</span> <span class="p">[</span><span class="nx">url</span><span class="p">,</span> <span class="p">...</span><span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">urls</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">text</span> <span class="p">=&gt;</span>
      <span class="nx">fetchSequentially</span><span class="p">(</span>
        <span class="nx">rest</span><span class="p">,</span>
        <span class="p">[...</span><span class="nx">data</span><span class="p">,</span> <span class="nx">text</span><span class="p">]</span>
      <span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>Using <code>await</code> + a loop, less bookkeeping, easier to read.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">fetchSequentially</span><span class="p">(</span><span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="nx">url</span> <span class="k">of</span> <span class="nx">urls</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">data</span>
<span class="p">}</span>
</code></pre></div>
<p>Remember to only make sequeuntial calls if the nth call rely on a previous call&rsquo;s output. Otherwise you might be able to run the whole thing in parallel.</p>

<h3 id="passing-data-in-sequential-async-calls">Passing data in sequential async calls</h3>

<p>Return array + destructuring in next call, very verbose in Promise chains:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">findLinks</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* some implementation */</span> <span class="p">}</span>

<span class="kd">function</span> <span class="nx">crawl</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">parentText</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;crawling links in: &#39;</span><span class="p">,</span> <span class="nx">parentText</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">text</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="nx">findLinks</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span>
      <span class="nx">text</span>
    <span class="p">]))</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">links</span><span class="p">,</span> <span class="nx">text</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
      <span class="nx">links</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">link</span> <span class="p">=&gt;</span> <span class="nx">crawl</span><span class="p">(</span><span class="nx">link</span><span class="p">,</span> <span class="nx">text</span><span class="p">))</span>
    <span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>Using <code>await</code> + data in the closure:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">findLinks</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* someimplementation */</span> <span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">crawl</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">parentText</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;crawling links in: &#39;</span><span class="p">,</span> <span class="nx">parentText</span><span class="p">);</span>
  <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
  <span class="k">const</span> <span class="nx">links</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">findLinks</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">crawl</span><span class="p">(</span><span class="nx">links</span><span class="p">,</span> <span class="nx">text</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="error-handling">Error handling</h3>

<p>Using try/catch, or <code>.catch</code>, try/catch means you&rsquo;ll also be <code>catch</code>-ing synchronous errors.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">withCatch</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;borked_url&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">withBlock</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;borked_url&#39;</span><span class="p">);</span>
    <span class="k">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="workshop-examples">Workshop Examples</h2>

<p>Example code at <a href="https://github.com/HugoDF/async-js-presentation/tree/master/workshop">github.com/HugoDF/async-js-presentation/tree/master/workshop</a></p>

<h3 id="callbackify-ing-a-promise-based-api">&ldquo;callbackify&rdquo;-ing a Promise-based API</h3>

<p>We&rsquo;re going to take <code>fetch</code> (see <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">MDN article on fetch</a>),
a browser API that exposes a Promise-based API to make HTTP calls.</p>

<p>We&rsquo;re going to write a <code>get(url, callback)</code> function, which takes a URL, fetches JSON from it and calls the callback with it (or with the error).</p>

<p>We&rsquo;ll use it like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;https://jsonplaceholder.typicode.com/todos&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>
<p>To being with let&rsquo;s define a <code>get</code> function with the right parameters, call fetch for the URL and get data:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// only needed in Node
</span><span class="c1"></span><span class="k">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-fetch&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="cm">/* we have the data now */</span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>Once we have the data, we can call <code>callback</code> with <code>null, data</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// only needed in Node
</span><span class="c1"></span><span class="k">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-fetch&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>And add the error handling step, <code>.catch((err) =&gt; callback(err))</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">// only needed in Node
</span><span class="c1"></span><span class="k">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-fetch&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>That&rsquo;s it, we&rsquo;ve written a wrapper that uses a callback API to make HTTP requests with a Promise-based client.</p>

<h3 id="getting-data-in-parallel-using-callbacks-the-pain">Getting data in parallel using callbacks: the pain</h3>

<p>Next we&rsquo;ll write a function that gets todos by id from the jsonplaceholder API using the <code>get</code> function we&rsquo;ve defined in the previous section.</p>

<p>Its usage will look something like this (to get ids 1, 2, 3, 10, 22):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">getTodosCallback</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>
<p>Let&rsquo;s define the function, we take the array of ids, and call <code>get</code> with its URL (baseUrl + id).</p>

<p>In the callback to the <code>get</code>, we&rsquo;ll check for errors.</p>

<p>Also, if the data for all the ids has been fetched, we&rsquo;ll call the callback with all the data.</p>

<p>That&rsquo;s a lot of bookkeeping and it doesn&rsquo;t even necessarily return the data in the right order.</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">&#39;https://jsonplaceholder.typicode.com/todos&#39;</span>

<span class="kd">function</span> <span class="nx">getTodosCallback</span><span class="p">(</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">const</span> <span class="nx">expectedLength</span> <span class="o">=</span> <span class="nx">ids</span><span class="p">.</span><span class="nx">length</span>

  <span class="nx">ids</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">get</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>

      <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">expectedLength</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>Here&rsquo;s the same functionality implemented with straight <code>fetch</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">getTodosPromise</span><span class="p">(</span><span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
    <span class="nx">ids</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kr">async</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">baseUrl</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
      <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">})</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Shorter, denser, and returns stuff in order.</p>

<h3 id="promisify-ing-a-callback-based-api">&ldquo;promisify&rdquo;-ing a callback-based API</h3>

<p>Historically Node&rsquo;s APIs and <code>fs</code> in particular have used a callback API.</p>

<p>Let&rsquo;s read a file using a Promise instead of <code>readFile(filePath, options, (err, data) =&gt; {})</code>.</p>

<p>We want to be able to use it like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./01-callbackify-fetch.js&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</code></pre></div>
<p>The <code>Promise</code> constructor takes a function which has 2 arguments, resolve and reject. They&rsquo;re both functions and we&rsquo;ll want to <code>resolve()</code> with a sucessful value and <code>reject()</code> on error.</p>

<p>So we end up with the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>That&rsquo;s all there is to it.</p>

<h3 id="why-we-don-t-mix-async-and-sync-operations">Why we don&rsquo;t mix async and sync operations</h3>

<p>Let&rsquo;s define an abritrary problem: I have some JSON files with information about browsers in a folder.</p>

<p>Given a piece of text that contains the browser name I would like to inject the statistics from the files in the folder.</p>

<p>Let&rsquo;s do a naive implementation, we have a <code>loadBrowserData</code> async function that reads the file and <code>JSON.parse</code>-s it.</p>

<p>We have a <code>badIdea</code> async function which loops through browsers and calls <code>text.replace()</code> with the browser name as the first parameter and an async function that fetches data and formats it as the second.</p>

<p><code>String.replace</code> does support a callback as the second parameter but it doesn&rsquo;t <code>await</code> it, it just expects a synchronous function, which means the following code:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">promises</span>
<span class="k">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>

<span class="k">const</span> <span class="nx">browsers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chrome&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;firefox&#39;</span><span class="p">,</span> <span class="s1">&#39;safari&#39;</span><span class="p">]</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">loadBrowserData</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;./04-data&#39;</span><span class="p">,</span> <span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">.json`</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">badIdea</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">newText</span> <span class="o">=</span> <span class="nx">text</span>
  <span class="nx">browsers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">browser</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">newText</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">const</span> <span class="p">{</span>
        <span class="nx">builtBy</span><span class="p">,</span>
        <span class="nx">latestVersion</span><span class="p">,</span>
        <span class="nx">lastYearUsage</span>
      <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loadBrowserData</span><span class="p">(</span><span class="nx">browser</span><span class="p">);</span>
      <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nx">browser</span><span class="si">}</span><span class="sb"> (</span><span class="si">${</span><span class="nx">builtBy</span><span class="si">}</span><span class="sb">, latest version: </span><span class="si">${</span><span class="nx">latestVersion</span><span class="si">}</span><span class="sb">, usage: </span><span class="si">${</span><span class="nx">lastYearUsage</span><span class="si">}</span><span class="sb">)`</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">newText</span>
<span class="p">}</span>

<span class="k">const</span> <span class="nx">myText</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">We love chrome and firefox.
</span><span class="sb">
</span><span class="sb">Despite their low usage, we also &lt;3 safari and edge.
</span><span class="sb">`</span><span class="p">;</span>

<span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">badIdea</span><span class="p">(</span><span class="nx">myText</span><span class="p">));</span>
<span class="p">})()</span>
</code></pre></div>
<p>Logs out:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">We love <span class="o">[</span>object Promise<span class="o">]</span> and <span class="o">[</span>object Promise<span class="o">]</span>.

Despite their low usage, we also &lt;<span class="m">3</span> <span class="o">[</span>object Promise<span class="o">]</span> and <span class="o">[</span>object Promise<span class="o">]</span>.</code></pre></div>
<p>If instead we load up all the browser data beforehand and use it synchronously, it works:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">promises</span>
<span class="k">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>

<span class="k">const</span> <span class="nx">browsers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chrome&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;firefox&#39;</span><span class="p">,</span> <span class="s1">&#39;safari&#39;</span><span class="p">]</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">loadBrowserData</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;./04-data&#39;</span><span class="p">,</span> <span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">.json`</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">betterIdea</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">browserNameDataPairs</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
    <span class="nx">browsers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
      <span class="kr">async</span> <span class="p">(</span><span class="nx">browser</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">[</span> <span class="nx">browser</span><span class="p">,</span> <span class="kr">await</span> <span class="nx">loadBrowserData</span><span class="p">(</span><span class="nx">browser</span><span class="p">)</span> <span class="p">]</span>
    <span class="p">)</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">browserToData</span> <span class="o">=</span> <span class="nx">browserNameDataPairs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span> <span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">acc</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span>
    <span class="k">return</span> <span class="nx">acc</span>
  <span class="p">},</span> <span class="p">{})</span>

  <span class="kd">let</span> <span class="nx">newText</span> <span class="o">=</span> <span class="nx">text</span>

  <span class="nx">browsers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">browser</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">newText</span> <span class="o">=</span> <span class="nx">newText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">const</span> <span class="p">{</span>
        <span class="nx">builtBy</span><span class="p">,</span>
        <span class="nx">latestVersion</span><span class="p">,</span>
        <span class="nx">lastYearUsage</span>
      <span class="p">}</span> <span class="o">=</span> <span class="nx">browserToData</span><span class="p">[</span><span class="nx">browser</span><span class="p">];</span>
      <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nx">browser</span><span class="si">}</span><span class="sb"> (</span><span class="si">${</span><span class="nx">builtBy</span><span class="si">}</span><span class="sb">, latest version: </span><span class="si">${</span><span class="nx">latestVersion</span><span class="si">}</span><span class="sb">, usage: </span><span class="si">${</span><span class="nx">lastYearUsage</span><span class="si">}</span><span class="sb">)`</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">newText</span>
<span class="p">}</span>

<span class="k">const</span> <span class="nx">myText</span> <span class="o">=</span> <span class="sb">`
</span><span class="sb">We love chrome and firefox.
</span><span class="sb">
</span><span class="sb">Despite their low usage, we also &lt;3 safari and edge.
</span><span class="sb">`</span><span class="p">;</span>

<span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">betterIdea</span><span class="p">(</span><span class="nx">myText</span><span class="p">));</span>
<span class="p">})()</span>
</code></pre></div>
<p>It logs out the expected:</p>

<pre><code>We love chrome (Google, latest version: 71, usage: 64.15%) and firefox (Mozilla, latest version: 64, usage: 9.89%).

Despite their low usage, we also &lt;3 safari (Apple, latest version: 12, usage: 3.80%) and edge (Microsoft, latest version: 18, usage: 4.30%).
</code></pre>

<h2 id="further-reading">Further Reading</h2>

<ul>
<li>About non-blocking I/O in Node.js docs: <a href="https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/">nodejs.org/en/docs/guides/blocking-vs-non-blocking/</a></li>
<li><a href="https://tylermcginnis.com/async-javascript-from-callbacks-to-promises-to-async-await/">Async JavaScript: From Callbacks, to Promises, to Async/Await</a> by Tyler McGinnis</li>
</ul>

<p>Are good reads in and around this subject. The secret to understanding asynchronous JavaScript behaviour is to experiment: turn callbacks into Promises and vice-versa.</p>

<p><a href="https://speakerdeck.com/hugodf/async-javascript-history-patterns-and-gotchas">View the original slides on SpeakerDeck</a> or <a href="https://github.com/HugoDF/async-js-presentation">from the GitHub repo</a>.</p>

<p>Let me know <a href="https://twitter.com/hugo__df">@hugo__df</a> if you need a hand 🙂.</p>
        </div>
    </section>

    <section class="subscribe-form">
        <h3 class="subscribe-form-title">Subscribe to Code with Hugo</h3>
        <p>Get all the posts of the week before anyone else in your inbox</p>
        <form
            action="https://buttondown.email/api/emails/embed-subscribe/hugo"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://buttondown.email/hugo', 'popupwindow')"
        >
            <div class="form-group">
                <input class="subscribe-email" type="email" name="email" id="bd-email" placeholder="youremail@example.com">
                <input type="hidden" value="1" name="embed"/>
            </div>
            <button class="" value="Subscribe" type="submit"><span>Subscribe</span></button>
        </form>
    </section>

    <footer class="post-full-footer">
      <section class="author-card">
        <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
        <section class="author-card-content">
            <h4 class="author-card-name"><a href="https://codewithhugo.com/">Hugo Di Francesco</a></h4>
                <p>A developer, working out of London writing CSS, JavaScript and Python.</p>
        </section>
      </section>
    </footer>
</article>


  <section class="overlay-cta">
    <div class="overlay-cta__inner">
      <div class="overlay-cta__text-container">
        <h3 class="cta-title overlay-cta__title">
          Subscribe to the Code with Hugo newsletter
        </h3>
        <p class="cta-text overlay-cta__text">
          Get the best and latest articles in your inbox every week
        </p>
      </div>
      <div class="overlay-cta__button-container">
        <a href="https://buttondown.email/hugo" class="button overlay-cta__button">
          Subscribe
        </a>
        <a href="#" class="overlay-cta__close">close</a>
      </div>
    </div>
  </section>



    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      
<article class="read-next-card" 
            style="background-image: url(https://codewithhugo.com/img/cover.jpg);" >
    <header class="read-next-card-header">
        <small class="read-next-card-header-sitetitle">&mdash; Code with Hugo &mdash;</small>
        
        <h3 class="read-next-card-header-title"><a href="https://codewithhugo.com/tags/javascript/">#JavaScript</a></h3>
    </header>
    <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
    </div>

    <div class="read-next-card-content">
      
        <ul>
          <li><a href="https://codewithhugo.com/10-minute-javascript-library-development-in-es6-with-babel-mocha-and-npm-scripts/">10 minute JavaScript: Library development in ES6 with Babel, Mocha and npm scripts</a></li>            
        
          <li><a href="https://codewithhugo.com/bring-redux-to-your-queue-logic-an-express-setup-with-es6-and-bull-queue/">Bring Redux to your queue logic: an Express setup with ES6 and bull queue</a></li>            
        
          <li><a href="https://codewithhugo.com/writing-multiple-vue-components-in-a-single-file/">Writing multiple Vue components in a single file</a></li>            
        
          <li><a href="https://codewithhugo.com/detecting-object-vs-array-in-javascript-by-example/">JavaScript “is array” in-depth</a></li>            
        </ul>
    </div>
    <footer class="read-next-card-footer">
      
        <a href="https://codewithhugo.com/tags/javascript/">See all related posts →</a>
    </footer>
</article>


      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/integrate-python-ruby-php-shell-with-node-js/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/elaine-casap-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/integrate-python-ruby-php-shell-with-node-js/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #JavaScript 
              #Node 
              #Python  </span>
              
              <h2 class="post-card-title">The comprehensive guide to integrating a Python/Ruby/PHP/shell script with Node.js using child_process.spawn</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>There are occasions when running a Python/Ruby/PHP shell script from Node.js is necessary. This post looks at best practices around leveraging child_process.spawn to encapsulate this call in Node.js/JavaScript.
The goal here is to have an interoperability layer between Node.js and an outside shell. This is a quick workaround if some other part of your system isn’t developed in JavaScript.
We’ll use spawn over exec because we’re talking about passing data, and potentially large amounts of it. To understand the difference between child_process.spawn and child_process.exec (see “Difference between spawn and exec of Node.js child_process”).
The long and short of it is use exec for small amounts of data (under 200k) using a Buffer interface and spawn for larger amounts using a stream interface.
spawn has a more verbose syntax for some of the use-cases we’ll look at, but it’s more serviceable for integrating with Ruby/Python/PHP since we might get more data than a couple of lines of text.

 ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/connect-to-mongodb-on-dokku-with-your-local-command-line-or-robo3t/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/cameron-kirby-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/connect-to-mongodb-on-dokku-with-your-local-command-line-or-robo3t/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #deployment 
              #dokku 
              #MongoDB  </span>
              
              <h2 class="post-card-title">Connect to MongoDB on Dokku with your local command line or Robo3T</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>The Dokku mongo plugin provides a mongo:connect command, which opens a tunnelled connection to you MongoDB instance on Dokku. This is how you can connect to your database using the tool of your choice, the examples will be using Robo3T.

 ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <div class="floating-header-logo">
    <a href="https://codewithhugo.com/">
      
      <span>Code with Hugo</span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">Async JavaScript: history, patterns and gotchas</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/></svg>
    </div>

    
    <a class="floating-header-share-tw" href="https://twitter.com/share?text=%22Async%20JavaScript%3a%20history%2c%20patterns%20and%20gotchas%22%20by%20%40hugo__df&amp;url=https%3a%2f%2fcodewithhugo.com%2fasync-js%2f&amp"
          onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
      </a>
      <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcodewithhugo.com%2fasync-js%2f"
          onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
      </a>
  </div>

  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/">Code with Hugo</a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        <a href="https://twitter.com/hugo__df" target="_blank" rel="noopener">Twitter</a>
        <a href="https://github.com/HugoDF" target="_blank" rel="noopener">Github</a>
        
        <a href="https://medium.com/@hugo__df" target="_blank" rel="noopener">Medium</a>
    </nav>  
  </div>
</footer>

</div>

<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://codewithhugo.com/js/jquery.fitvids.js"></script>




  <!-- Google Analytics -->
  <script>
    var _gaq=[['_setAccount','UA-60469708-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>



<script async src="//cdn.simpleanalytics.io/hello.js"></script>
<noscript><img src="//api.simpleanalytics.io/hello.gif" alt=""></noscript>





<script>
  (function (document) {
    function getLastDocumentHeight(document) {
      var body = document.body;
      var html = document.documentElement;
      return Math.max(
        body.scrollHeight, body.offsetHeight,
        html.clientHeight, html.scrollHeight,
        html.offsetHeight
      );
    }

    var $overlay = document.querySelector('.overlay-cta');
    var hiddenClass = 'overlay-cta--hidden';
    var closedClass = 'overlay-cta--closed';
    $overlay.classList.add(hiddenClass);

    
    var $overlayClose = document.querySelector('.overlay-cta__close');
    var overlayCloseListener = $overlayClose.addEventListener('click', function (e) {
      e.preventDefault();
      $overlay.classList.add(closedClass);
    });

    var $heroCtaButton = document.querySelector('.hero-cta .button');
    var $firstContentItem = document.querySelector('.post-full-content > * > *');
    var title = $heroCtaButton || $firstContentItem;

    var $subscribeBox = document.querySelector('.subscribe-form');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = getLastDocumentHeight(document);
    var ticking = false;


    function onScroll() {
      lastScrollY = window.scrollY;
      requestTick();
    }

    function onResize() {
      lastWindowHeight = window.innerHeight;
      lastDocumentHeight = getLastDocumentHeight(document);
      requestTick();
    }

    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(update);
      }
      ticking = true;
    }

    function update() {
      var trigger = title.getBoundingClientRect().top + window.scrollY;
      var triggerOffset = title.offsetHeight + 35;
      var lastShowCtaBoxHeight = $subscribeBox.getBoundingClientRect().top ;
      
      if (
        lastScrollY >= trigger + triggerOffset &&
        lastShowCtaBoxHeight > lastWindowHeight
      ) {
        $overlay.classList.remove(hiddenClass);
      } else {
        $overlay.classList.add(hiddenClass);
      }

      ticking = false;
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize, false);

    update();
  })(document);
</script>


    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
