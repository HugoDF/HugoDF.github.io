<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="gBfbdXRLofaOyHsbgiSiuCIHKPaviGMRVWh_qOfDHNE" />

    <title>ES6 by example: a module/CLI to wait for Postgres in docker-compose &middot; Code with Hugo</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://codewithhugo.com/favicon.ico" />
    <meta name="theme-color" content="#090a0b">
    
    <link rel="canonical" href="https://codewithhugo.com/es6-by-example-a-module/cli-to-wait-for-postgres-in-docker-compose/" /> 

     <meta name="description" content="&lt;p&gt;When using docker-compose, it‚Äôs good practice to make anything that relies on Postgres wait for it to be up before launching. This avoids connection issues i" /> 

     
    
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://codewithhugo.com/img/matthew-henry-unsplash.jpg"/>
    
 
    <meta name="twitter:title" content="ES6 by example: a module/CLI to wait for Postgres in docker-compose"/>
    <meta name="twitter:description" content="&lt;p&gt;When using docker-compose, it‚Äôs good practice to make anything that relies on Postgres wait for it to be up before launching. This avoids connection issues i"/>
    <meta name="twitter:url" content="https://codewithhugo.com/es6-by-example-a-module/cli-to-wait-for-postgres-in-docker-compose/" />
    <meta name="twitter:site" content="@hugo__df"/>

    <meta property="og:site_name" content="Code with Hugo" />
    <meta property="og:title" content="ES6 by example: a module/CLI to wait for Postgres in docker-compose &middot; Code with Hugo" />
    <meta property="og:url" content="https://codewithhugo.com/es6-by-example-a-module/cli-to-wait-for-postgres-in-docker-compose/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="&lt;p&gt;When using docker-compose, it‚Äôs good practice to make anything that relies on Postgres wait for it to be up before launching. This avoids connection issues i" />

    <meta property="article:published_time" content="2018-07-11T00:00:00Z" />
    <meta property="article:tag" content="JavaScript" /><meta property="article:tag" content="Node" />

    <meta property="og:image" content="https://codewithhugo.com/img/matthew-henry-unsplash.jpg"/>


    <meta name="generator" content="Hugo 0.46" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://codewithhugo.com/css/casper-two.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/overrides.min.bd35cf74c58c56c4aa8eff40730357744dec20ff31d8bae7b0618dbe30e0dbe4.css">
    
      
      <link rel="stylesheet" href="https://codewithhugo.com/syntax.min.e1646a3f88f77e1b5e7d0253633b1958013aa132890dfe4d7e15dc4718d4aecc.css">
    

    

     
</head>


<body class="post-template">
  <div class="site-wrapper"> 

<header class="site-header outer">
  <div class="inner">
    <nav class="site-nav">
      <div class="site-nav-left">

        <ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/javascript/">JavaScript</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/node/">Node</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/css/">CSS</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/tags/tip/">tips</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    <a class="social-link social-link-tw" href="https://twitter.com/hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg></a>

                    <a class="social-link" href="https://github.com/HugoDF" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    <a class="social-link" href="https://medium.com/@hugo__df" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 195 195"><path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z"/></svg></a>
        </div>  
        
        <a class="subscribe-button" href="https://codewithhugo.com/index.xml">Subscribe</a>
            
      </div>

    </nav>  

  </div>
</header>

<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
      <article class="post-full post">
    <header class="post-full-header">
        <section class="post-full-meta">
            <time class="post-full-meta-date" datetime="2018-07-11">11 July 2018</time>
                <span class="date-divider">/</span> <a href="https://codewithhugo.com/tags/javascript/">#JavaScript</a>&nbsp;<a href="https://codewithhugo.com/tags/node/">#Node</a>&nbsp;
        </section>
        <h1 class="post-full-title">ES6 by example: a module/CLI to wait for Postgres in docker-compose</h1>
    </header>
    <div class="hero-container">

      
      <figure class="post-full-image" style="background-image: url(https://codewithhugo.com/img/matthew-henry-unsplash.jpg)">
        

      </figure>
    </div>

    <section class="post-full-content">
        <div class="kg-card-markdown">
        <p>When using docker-compose, it‚Äôs good practice to make anything that relies on Postgres wait for it to be up before launching. This avoids connection issues inside the app.</p>

<p>This post walks through how to deliver this functionality both as a CLI and a module that works both as a CommonJS module (<code>require</code>) and ES modules, <strong>without transpilation</strong>.</p>

<p>‚ÄúA fast, production ready, zero-dependency ES module loader for Node 6+!‚Äù is <a href="https://github.com/standard-things/esm">esm</a>‚Äôs promise. From this sample project, it‚Äôs worked.</p>

<p></p>

<!-- Break the table of contents so it doesn't auto-update with emoji -->

<!--

- [Writing ES modules without a build step üé®](#writing-es-modules-without-a-build-step-%F0%9F%8E%A8)
- [Sane defaults üóÉ](#sane-defaults-%F0%9F%97%83)
  - [Attempting to destructure null or undefined 0Ô∏è‚É£](#attempting-to-destructure-null-or-undefined-0%EF%B8%8F%E2%83%A3)
  - [‚Äònull‚Äô remains, undefined gets defaulted üîé](#%E2%80%98null%E2%80%99-remains-undefined-gets-defaulted-%F0%9F%94%8E)
- [Waiting for Postgres with async/await üõé](#waiting-for-postgres-with-asyncawait-%F0%9F%9B%8E)
- [Integrating as a CLI with `meow` üòº](#integrating-as-a-cli-with-meow-%F0%9F%98%BC)
- [Packaging and clean up üì§](#packaging-and-clean-up-%F0%9F%93%A4)
- [Extras](#extras)
  - [Publishing to npm with np](#publishing-to-npm-with-np)
  - [Pointing to the ESM version of the module](#pointing-to-the-esm-version-of-the-module)
  - [A Promise wait-for-pg implementation](#a-promise-wait-for-pg-implementation)

-->

<ul>
<li><a href="#writing-es-modules-without-a-build-step">Writing ES modules without a build step üé®</a></li>
<li><a href="#sane-defaults">Sane defaults üóÉ</a>

<ul>
<li><a href="#attempting-to-destructure-null-or-undefined">Attempting to destructure null or undefined 0Ô∏è‚É£</a></li>
<li><a href="#null-remains-undefined-gets-defaulted">‚Äònull‚Äô remains, undefined gets defaulted üîé</a></li>
</ul></li>
<li><a href="#waiting-for-postgres-with-asyncawait">Waiting for Postgres with async/await üõé</a></li>
<li><a href="#integrating-as-a-cli-with-meow">Integrating as a CLI with <code>meow</code> üòº</a></li>
<li><a href="#packaging-and-clean-up">Packaging and clean up üì§</a></li>
<li><a href="#extras">Extras</a>

<ul>
<li><a href="#publishing-to-npm-with-np">Publishing to npm with np</a></li>
<li><a href="#pointing-to-the-esm-version-of-the-module">Pointing to the ESM version of the module</a></li>
<li><a href="#a-promise-wait-for-pg-implementation">A Promise wait-for-pg implementation</a></li>
</ul></li>
</ul>

<blockquote>
<p>This was sent out on the <a href="https://buttondown.email/hugo">Code with Hugo newsletter</a> last Monday.
<a href="https://buttondown.email/hugo">Subscribe</a> to get the latest posts right in your inbox (before anyone else).</p>
</blockquote>

<h1 id="writing-es-modules-without-a-build-step">Writing ES modules without a build step üé®</h1>

<p>To begin we install <code>esm</code>: <code>npm install --save esm</code>.
Next we‚Äôll need a file for our module, <code>wait-for-pg.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span></code></pre></div>
<p>Trying to run this file with Node will throw:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node wait-for-pg.js
/wait-for-pg/wait-for-pg.js:1
<span class="nb">export</span> const <span class="nv">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
^^^^^^

SyntaxError: Unexpected token export</code></pre></div>
<p><code>export</code> and <code>import</code> don‚Äôt work in Node yet (without flags), the following runs though:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm wait-for-pg.js</code></pre></div>
<p>That‚Äôs if we want to run it as a script, say we want to let someone else consume it via <code>require</code> we‚Äôll need an <code>index.js</code> with the following content:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">require</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;esm&#39;</span><span class="p">)(</span><span class="nx">module</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">);</span>
</code></pre></div>
<p>We can now run <code>index.js</code> as a script:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node index.js</code></pre></div>
<p>We can also <code>require</code> it:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node <span class="c1"># start the Node REPL
</span><span class="c1"></span>&gt; require<span class="o">(</span><span class="s1">&#39;./index.js&#39;</span><span class="o">)</span>
<span class="o">{</span> DEFAULT_MAX_ATTEMPTS: <span class="m">10</span>,
  DEFAULT_DELAY: <span class="m">1000</span> <span class="o">}</span></code></pre></div>
<p>To tell users wanting to <code>require</code> the package with Node, we can use the <code>&quot;main&quot;</code>  field in <code>package.json</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.0.62&#34;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h1 id="sane-defaults">Sane defaults üóÉ</h1>

<p>To default  <code>databaseUrl</code>, <code>maxAttempts</code> and <code>delay</code>, we use ES6 default parameters + parameter destructuring.
Let‚Äôs have a look through some gotchas of default parameters that we‚Äôll want to avoid:</p>

<ol>
<li>Attempting to destructure ‚Äònull‚Äô or ‚Äòundefined‚Äô</li>
<li>‚Äònull‚Äô remains, undefined gets defaulted</li>
</ol>

<h2 id="attempting-to-destructure-null-or-undefined-0">Attempting to destructure null or undefined 0Ô∏è‚É£</h2>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span> 
    <span class="s1">&#39;postgres://postgres@localhost&#39;</span>
  <span class="p">),</span>
  <span class="nx">maxAttempts</span> <span class="o">=</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">delay</span> <span class="o">=</span> <span class="nx">DEFAULT_DELAY</span>
<span class="p">})</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="nx">databaseUrl</span><span class="p">,</span> 
    <span class="nx">maxAttempts</span><span class="p">,</span>
    <span class="nx">delay</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Callings the following will throw:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm <span class="c1"># node REPL
</span><span class="c1"></span>&gt; import <span class="o">{</span> waitForPostgres <span class="o">}</span> from <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
&gt; waitForPostgres<span class="o">()</span>
TypeError: Cannot destructure property <span class="sb">`</span>databaseUrl<span class="sb">`</span> of <span class="s1">&#39;undefined&#39;</span> or <span class="s1">&#39;null&#39;</span>.
    at waitForPostgres <span class="o">(</span>/wait-for-pg/wait-for-pg.js:4:19<span class="o">)</span>
&gt; waitForPostgres<span class="o">(</span>null<span class="o">)</span>
TypeError: Cannot destructure property <span class="sb">`</span>databaseUrl<span class="sb">`</span> of <span class="s1">&#39;undefined&#39;</span> or <span class="s1">&#39;null&#39;</span>.
    at waitForPostgres <span class="o">(</span>/wait-for-pg/wait-for-pg.js:4:19<span class="o">)</span></code></pre></div>
<p>To avoid this, we should add <code>= {}</code> to default the parameter that‚Äôs being destructured (<code>wait-for-pg.js</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span> 
    <span class="s1">&#39;postgres://postgres@localhost&#39;</span>
  <span class="p">),</span>
  <span class="nx">maxAttempts</span> <span class="o">=</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">delay</span> <span class="o">=</span> <span class="nx">DEFAULT_DELAY</span>
<span class="p">}</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="nx">databaseUrl</span><span class="p">,</span> 
    <span class="nx">maxAttempts</span><span class="p">,</span>
    <span class="nx">delay</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>It now runs:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm <span class="c1"># node REPL
</span><span class="c1"></span>&gt; import <span class="o">{</span> waitForPostgres <span class="o">}</span> from <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
&gt; waitForPostgres<span class="o">()</span>
postgres://postgres@localhost <span class="m">10</span> <span class="m">1000</span></code></pre></div>
<p>The values were successfully defaulted when not passed a parameter. However the following still errors:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">&gt; waitForPostgres<span class="o">(</span>null<span class="o">)</span>
postgres://postgres@localhost <span class="m">10</span> <span class="m">1000</span>
TypeError: Cannot destructure property <span class="sb">`</span>databaseUrl<span class="sb">`</span> of <span class="s1">&#39;undefined&#39;</span> or <span class="s1">&#39;null&#39;</span>.
    at waitForPostgres <span class="o">(</span>/wait-for-pg/wait-for-pg.js:4:19<span class="o">)</span></code></pre></div>
<h2 id="null-remains-undefined-gets-defaulted">‚Äònull‚Äô remains, undefined gets defaulted üîé</h2>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm <span class="c1"># node REPL
</span><span class="c1"></span>&gt; import <span class="o">{</span> waitForPostgres <span class="o">}</span> from <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
&gt; waitForPostgres<span class="o">({</span> databaseUrl: null, maxAttempts: undefined <span class="o">})</span>
null <span class="m">10</span> <span class="m">1000</span></code></pre></div>
<p>The values explicitly set as <code>null</code> doesn‚Äôt get defaulted whereas an explicit <code>undefined</code> and an implicit one do, that‚Äôs just how default parameters work, which isn‚Äôt exactly like the old-school way of writing this:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">waitForPostgres</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">databaseUrl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">databaseUrl</span> <span class="o">||</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span>
    <span class="s1">&#39;postgres://postgres@localhost&#39;</span>
  <span class="p">);</span>
  <span class="k">const</span> <span class="nx">maxAttempts</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxAttempts</span> <span class="o">||</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">;</span>
  <span class="k">const</span> <span class="nx">delay</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">delay</span> <span class="o">||</span> <span class="nx">DEFAULT_DELAY</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="nx">databaseUrl</span><span class="p">,</span> 
    <span class="nx">maxAttempts</span><span class="p">,</span>
    <span class="nx">delay</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Which would yield the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm <span class="c1"># node REPL
</span><span class="c1"></span>&gt; import <span class="o">{</span> waitForPostgres <span class="o">}</span> from <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
&gt; waitForPostgres<span class="o">({</span> databaseUrl: null, maxAttempts: undefined <span class="o">})</span>
<span class="s1">&#39;postgres://postgres@localhost&#39;</span> <span class="m">10</span> <span class="m">1000</span></code></pre></div>
<p>Since <code>null</code> is just as falsy as <code>undefined</code> üôÇ .</p>

<h1 id="waiting-for-postgres-with-async-await">Waiting for Postgres with async/await üõé</h1>

<p>Time to implement <code>wait-for-pg</code>.
To wait for Postgres we‚Äôll want to:</p>

<ul>
<li>try to connect to it</li>
<li>if that fails

<ul>
<li>try again later</li>
</ul></li>
<li>if that succeeds

<ul>
<li>finish</li>
</ul></li>
</ul>

<p>Let‚Äôs install a Postgres client, <code>pg</code> using: <code>npm install --save pg</code></p>

<p><code>pg</code> has a <code>Client</code> object that we can pass a database URL to when instantiating it (<code>new Client(databaseUrl)</code>). That <code>client</code> instance has a <code>.connect</code> method that returns a Promise which resolves on connection success and rejects otherwise.
That means if we mark the <code>waitForPostgres</code> function as <code>async</code>, we can <code>await</code> the <code>.connect</code> call.</p>

<p>When <code>await</code>-ing a Promise, a rejection will throw an error so we wrap all the logic in a <code>try/catch</code>.</p>

<ul>
<li>If the client connection succeeds we flip the loop condition so that the function terminates</li>
<li>If the client connection fails

<ul>
<li>we increment the <code>retries</code> counter, if it‚Äôs above the maximum number of retries (<code>maxAttempts</code>), we <code>throw</code> which, since we‚Äôre in an <code>async</code> function <code>throw</code> is the equivalent of doing <code>Promise.reject</code></li>
<li>otherwise we call another function that returns a Promise (<code>timeout</code>) which allows us to wait before doing another iteration of the loop body</li>
</ul></li>
<li>We make sure to <code>export function waitForPostgres() {}</code></li>
</ul>

<p><code>wait-for-pg.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">import</span> <span class="p">{</span> <span class="nx">Client</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;pg&#39;</span><span class="p">;</span>

<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span>
<span class="k">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">ms</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span>
  <span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span> 
    <span class="s1">&#39;postgres://postgres@localhost&#39;</span>
  <span class="p">),</span>
  <span class="nx">maxAttempts</span> <span class="o">=</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">delay</span> <span class="o">=</span> <span class="nx">DEFAULT_DELAY</span>
<span class="p">}</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">didConnect</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">didConnect</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">databaseUrl</span><span class="p">);</span>
      <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Postgres is up&#39;</span><span class="p">);</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="nx">didConnect</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">retries</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">&gt;</span> <span class="nx">maxAttempts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Postgres is unavailable - sleeping&#39;</span><span class="p">);</span>
      <span class="kr">await</span> <span class="nx">timeout</span><span class="p">(</span><span class="nx">delay</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="integrating-as-a-cli-with-meow">Integrating as a CLI with <code>meow</code> üòº</h1>

<p><a href="https://www.npmjs.com/package/meow">meow</a> is a CLI app helper from Sindre Sohrus, install it: <code>npm install --save meow</code>
Create <code>wait-for-pg-cli.module.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">import</span> <span class="p">{</span>
  <span class="nx">waitForPostgres</span><span class="p">,</span>
  <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">DEFAULT_DELAY</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">meow</span> <span class="nx">from</span> <span class="s1">&#39;meow&#39;</span><span class="p">;</span>

<span class="k">const</span> <span class="nx">cli</span> <span class="o">=</span> <span class="nx">meow</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    Usage
</span><span class="sb">      $ wait-for-pg &lt;DATABASE_URL&gt;
</span><span class="sb">    Options
</span><span class="sb">      --max-attempts, -c Maximum number of attempts, default: </span><span class="si">${</span><span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="si">}</span><span class="sb">
</span><span class="sb">      --delay, -d Delay between connection attempts in ms, default: </span><span class="si">${</span><span class="nx">DEFAULT_DELAY</span><span class="si">}</span><span class="sb">
</span><span class="sb">    Examples
</span><span class="sb">      $ wait-for-pg postgres://postgres@localhost:5432 -c 5 -d 3000 &amp;&amp; npm start
</span><span class="sb">      # waits for postgres, 5 attempts at a 3s interval, if
</span><span class="sb">      # postgres becomes available, run &#39;npm start&#39;
</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">inferType</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">flags</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">maxAttempts</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="nx">alias</span><span class="o">:</span> <span class="s1">&#39;c&#39;</span>
      <span class="p">},</span>
      <span class="nx">delay</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="nx">alias</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">cli</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">);</span>
</code></pre></div>
<p>We use <code>inferType</code> so that the values for <code>maxAttempts</code> and <code>delay</code> get converted to numbers instead of being strings.
We can run it using:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm wait-for-pg-cli.module.js
<span class="o">[]</span> <span class="o">{}</span></code></pre></div>
<p>The following is a template string, it will replace things inside of <code>${}</code> with the value in the corresponding expression (in this instance the value of the <code>DEFAULT_MAX_ATTEMPTS</code> and <code>DEFAULT_DELAY</code> variables)</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="sb">`
</span><span class="sb">  Usage
</span><span class="sb">    $ wait-for-pg &lt;DATABASE_URL&gt;
</span><span class="sb">  Options
</span><span class="sb">    --max-attempts, -c Maximum number of attempts, default: </span><span class="si">${</span><span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="si">}</span><span class="sb">
</span><span class="sb">    --delay, -d Delay between connection attempts in ms, default: </span><span class="si">${</span><span class="nx">DEFAULT_DELAY</span><span class="si">}</span><span class="sb">
</span><span class="sb">  Examples
</span><span class="sb">    $ wait-for-pg postgres://postgres@localhost:5432 -c 5 -d 3000 &amp;&amp; npm start
</span><span class="sb">    # waits for postgres, 5 attempts at a 3s interval, if
</span><span class="sb">    # postgres becomes available, run &#39;npm start&#39;
</span><span class="sb">`</span><span class="p">;</span>
</code></pre></div>
<p>To get the flags and first input, <code>wait-for-pg-cli.module.js</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">import</span> <span class="p">{</span>
  <span class="nx">waitForPostgres</span><span class="p">,</span>
  <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">DEFAULT_DELAY</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./wait-for-pg&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">meow</span> <span class="nx">from</span> <span class="s1">&#39;meow&#39;</span><span class="p">;</span>

<span class="k">const</span> <span class="nx">cli</span> <span class="o">=</span> <span class="nx">meow</span><span class="p">(</span><span class="sb">`
</span><span class="sb">    Usage
</span><span class="sb">      $ wait-for-pg &lt;DATABASE_URL&gt;
</span><span class="sb">    Options
</span><span class="sb">      --max-attempts, -c Maximum number of attempts, default: </span><span class="si">${</span><span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="si">}</span><span class="sb">
</span><span class="sb">      --delay, -d Delay between connection attempts in ms, default: </span><span class="si">${</span><span class="nx">DEFAULT_DELAY</span><span class="si">}</span><span class="sb">
</span><span class="sb">    Examples
</span><span class="sb">      $ wait-for-pg postgres://postgres@localhost:5432 -c 5 -d 3000 &amp;&amp; npm start
</span><span class="sb">      # waits for postgres, 5 attempts at a 3s interval, if
</span><span class="sb">      # postgres becomes available, run &#39;npm start&#39;
</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">inferType</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">flags</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">maxAttempts</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="nx">alias</span><span class="o">:</span> <span class="s1">&#39;c&#39;</span>
      <span class="p">},</span>
      <span class="nx">delay</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="nx">alias</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
  <span class="nx">maxAttempts</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">maxAttempts</span><span class="p">,</span>
  <span class="nx">delay</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">delay</span><span class="p">,</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">).</span><span class="k">catch</span><span class="p">(</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>If you don‚Äôt have a Postgres instance running on localhost the following shouldn‚Äôt print <code>Here</code>, that‚Äôs thanks to <code>process.exit(1)</code> in the <code>.catch</code> block:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ node -r esm wait-for-pg-cli.module.js -c <span class="m">5</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;Here&#34;</span>
Postgres is unavailable - sleeping
Postgres is unavailable - sleeping
Postgres is unavailable - sleeping
Postgres is unavailable - sleeping
Postgres is unavailable - sleeping</code></pre></div>
<h1 id="packaging-and-clean-up">Packaging and clean up üì§</h1>

<p>We can use the <code>&quot;bin&quot;</code> key in <code>package.json</code> to be able to run the command easily:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;bin&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;wait-for-pg&#34;</span><span class="p">:</span> <span class="s2">&#34;./wait-for-pg-cli.js&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.0.62&#34;</span><span class="p">,</span>
    <span class="nt">&#34;meow&#34;</span><span class="p">:</span> <span class="s2">&#34;^5.0.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;pg&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.3&#34;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Where <code>wait-for-pg-cli.js</code> is:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/usr/bin/env node
</span><span class="cp"></span><span class="nv">require</span> <span class="o">=</span> require<span class="o">(</span><span class="s2">&#34;esm&#34;</span><span class="o">)(</span>module/*, options*/<span class="o">)</span><span class="p">;</span>
module.exports <span class="o">=</span> require<span class="o">(</span><span class="s1">&#39;./wait-for-pg-cli.module&#39;</span><span class="o">)</span><span class="p">;</span></code></pre></div>
<p>Don‚Äôt forget to run <code>chmod +x wait-for-pg-cli.js</code>
<code>esm</code> allows us to use top-level await, that means in <code>wait-for-pg-cli.module.js</code>, we can replace:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
  <span class="nx">maxAttempts</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">maxAttempts</span><span class="p">,</span>
  <span class="nx">delay</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">delay</span><span class="p">,</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">).</span><span class="k">catch</span><span class="p">(</span>
  <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>With:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">try</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">waitForPostgres</span><span class="p">({</span>
    <span class="nx">databaseUrl</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">maxAttempts</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">maxAttempts</span><span class="p">,</span>
    <span class="nx">delay</span><span class="o">:</span> <span class="nx">cli</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">delay</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Running the CLI throws:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ ./wait-for-pg-cli.js
wait-for-pg/wait-for-pg-cli.module.js:36
  await waitForPostgres<span class="o">({</span>
  ^^^^^

SyntaxError: await is only valid in async <span class="k">function</span></code></pre></div>
<p>We need to add <code>&quot;esm&quot;</code> with <code>&quot;await&quot;: true</code> in <code>package.json</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;bin&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;wait-for-pg&#34;</span><span class="p">:</span> <span class="s2">&#34;./wait-for-pg-cli.js&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.0.62&#34;</span><span class="p">,</span>
    <span class="nt">&#34;meow&#34;</span><span class="p">:</span> <span class="s2">&#34;^5.0.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;pg&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.3&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;await&#34;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>This now works:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ ./wait-for-pg-cli.js -c <span class="m">1</span>
Postgres is unavailable - sleeping</code></pre></div>
<h1 id="extras">Extras</h1>

<blockquote>
<p>This was sent out on the <a href="https://buttondown.email/hugo">Code with Hugo newsletter</a> last Monday.
<a href="https://buttondown.email/hugo">Subscribe</a> to get the latest posts right in your inbox (before anyone else).</p>
</blockquote>

<h2 id="publishing-to-npm-with-np">Publishing to npm with np</h2>

<ol>
<li>Run: <code>npm install --save-dev np</code></li>
<li>Make sure you have a valid <code>&quot;name&quot;</code> field in <code>package.json</code>, eg. <code>&quot;@hugodf/wait-for-pg&quot;</code></li>
<li><code>npx np</code> for npm v5+ or <code>./node_modules/.bin/np</code> (npm v4 and down)</li>
</ol>

<h2 id="pointing-to-the-esm-version-of-the-module">Pointing to the ESM version of the module</h2>

<p>Use the <code>&quot;module&quot;</code> fields in <code>package.json</code></p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;wait-for-pg&#34;</span><span class="p">,</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Wait for postgres&#34;</span><span class="p">,</span>
  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;wait-for-pg.js&#34;</span><span class="p">,</span>
  <span class="nt">&#34;bin&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;wait-for-pg&#34;</span><span class="p">:</span> <span class="s2">&#34;./wait-for-pg-cli.js&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.0.62&#34;</span><span class="p">,</span>
    <span class="nt">&#34;meow&#34;</span><span class="p">:</span> <span class="s2">&#34;^5.0.0&#34;</span><span class="p">,</span>
    <span class="nt">&#34;pg&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.3&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;np&#34;</span><span class="p">:</span> <span class="s2">&#34;^3.0.4&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;esm&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;await&#34;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h2 id="a-promise-wait-for-pg-implementation">A Promise wait-for-pg implementation</h2>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="k">import</span> <span class="p">{</span> <span class="nx">Client</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;pg&#39;</span><span class="p">;</span>

<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="k">export</span> <span class="k">const</span> <span class="nx">DEFAULT_DELAY</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// in ms
</span><span class="c1"></span>
<span class="k">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">ms</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span>
  <span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">waitForPostgres</span><span class="p">({</span>
  <span class="nx">databaseUrl</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DATABASE_URL</span> <span class="o">||</span>
    <span class="s1">&#39;postgres://postgres@localhost&#39;</span>
  <span class="p">),</span>
  <span class="nx">maxAttempts</span> <span class="o">=</span> <span class="nx">DEFAULT_MAX_ATTEMPTS</span><span class="p">,</span>
  <span class="nx">delay</span> <span class="o">=</span> <span class="nx">DEFAULT_DELAY</span><span class="p">,</span>
<span class="p">}</span> <span class="o">=</span> <span class="p">{},</span>
  <span class="nx">retries</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">databaseUrl</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Postgres is up&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">&gt;</span> <span class="nx">maxAttempts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Postgres is unavailable - sleeping&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">timeout</span><span class="p">(</span><span class="nx">delay</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
        <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">waitForPostgres</span><span class="p">(</span>
          <span class="p">{</span> <span class="nx">databaseUrl</span><span class="p">,</span> <span class="nx">maxAttempts</span><span class="p">,</span> <span class="nx">delay</span> <span class="p">},</span>
          <span class="nx">retries</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><a style="background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, Helvetica, Ubuntu, Roboto, Noto, &quot;Segoe UI&quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px" href="https://unsplash.com/@matthewhenry?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge" target="_blank" rel="noopener noreferrer" title="Download free do whatever you want high-resolution photos from Matthew Henry"><span style="display:inline-block;padding:2px 3px"><svg xmlns="http://www.w3.org/2000/svg" style="height:12px;width:auto;position:relative;vertical-align:middle;top:-1px;fill:white" viewBox="0 0 32 32"><title>unsplash-logo</title><path d="M20.8 18.1c0 2.7-2.2 4.8-4.8 4.8s-4.8-2.1-4.8-4.8c0-2.7 2.2-4.8 4.8-4.8 2.7.1 4.8 2.2 4.8 4.8zm11.2-7.4v14.9c0 2.3-1.9 4.3-4.3 4.3h-23.4c-2.4 0-4.3-1.9-4.3-4.3v-15c0-2.3 1.9-4.3 4.3-4.3h3.7l.8-2.3c.4-1.1 1.7-2 2.9-2h8.6c1.2 0 2.5.9 2.9 2l.8 2.4h3.7c2.4 0 4.3 1.9 4.3 4.3zm-8.6 7.5c0-4.1-3.3-7.5-7.5-7.5-4.1 0-7.5 3.4-7.5 7.5s3.3 7.5 7.5 7.5c4.2-.1 7.5-3.4 7.5-7.5z"></path></svg></span><span style="display:inline-block;padding:2px 3px">Matthew Henry</span></a></p>
        </div>
    </section>

    <section class="subscribe-form">
        <h3 class="subscribe-form-title">Subscribe to Code with Hugo</h3>
        <p>Get all the posts of the week before anyone else in your inbox</p>
        <form
            action="https://buttondown.email/api/emails/embed-subscribe/hugo"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://buttondown.email/hugo', 'popupwindow')"
        >
            <div class="form-group">
                <input class="subscribe-email" type="email" name="email" id="bd-email" placeholder="youremail@example.com">
                <input type="hidden" value="1" name="embed"/>
            </div>
            <button class="" value="Subscribe" type="submit"><span>Subscribe</span></button>
        </form>
    </section>

    <footer class="post-full-footer">
      <section class="author-card">
        <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
        <section class="author-card-content">
            <h4 class="author-card-name"><a href="https://codewithhugo.com/">Hugo Di Francesco</a></h4>
                <p>A developer, working out of London writing CSS, JavaScript and Python.</p>
        </section>
      </section>
    </footer>
</article>




    
    
    

  </div>
</main>


<aside class="read-next outer">
  <div class="inner">
    <div class="read-next-feed">      
      
<article class="read-next-card" 
            style="background-image: url(https://codewithhugo.com/img/cover.jpg);" >
    <header class="read-next-card-header">
        <small class="read-next-card-header-sitetitle">&mdash; Code with Hugo &mdash;</small>
        
        <h3 class="read-next-card-header-title"><a href="https://codewithhugo.com/tags/javascript/">#JavaScript</a></h3>
    </header>
    <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
    </div>

    <div class="read-next-card-content">
      
        <ul>
          <li><a href="https://codewithhugo.com/ditch-syntax-highlighting-for-better-technical-writing/">Ditch syntax highlighting for better technical writing</a></li>            
        
          <li><a href="https://codewithhugo.com/a-gentle-introduction-to-graphql-api-integrations/">A gentle introduction to GraphQL API integrations</a></li>            
        
          <li><a href="https://codewithhugo.com/split-an-existing-git-commit/">Split an existing git commit</a></li>            
        
          <li><a href="https://codewithhugo.com/setting-up-express-and-redis-with-docker-compose/">Setting up Express and Redis with Docker compose</a></li>            
        </ul>
    </div>
    <footer class="read-next-card-footer">
      
        <a href="https://codewithhugo.com/tags/javascript/">See all related posts ‚Üí</a>
    </footer>
</article>


      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/bring-redux-to-your-queue-logic-an-express-setup-with-es6-and-bull-queue/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/michal-parzuchowski-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/bring-redux-to-your-queue-logic-an-express-setup-with-es6-and-bull-queue/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #JavaScript 
              #Node 
              #Docker 
              #redis  </span>
              
              <h2 class="post-card-title">Bring Redux to your queue logic: an Express setup with ES6 and bull queue</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>There always comes a point in a web application&rsquo;s life where an operation is best served in the background, this is where queues come in.
There are a few queuing solutions in Node. None of them are ridiculously dominant, eg. Kue, RSMQ, Bee Queue, bull. The issue with Kue, RSMQ and Bee Queue was its use of a done callback as the recommended API.
Bull https://github.com/OptimalBits/bull is a premium Queue package for handling jobs and messages in NodeJS. It‚Äôs backed by Redis and is pretty feature-rich. Most of all, it leverages a Promise-based processing API which means async/await.
We‚Äôll walk through an application that sends webhooks with a given payload to a set of URLs.

 ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
      
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://codewithhugo.com/better-http-polling-with-rxjs-5/">
      <div class="post-card-image" style="background-image: url(https://codewithhugo.com/img/jp-valery-unsplash.jpg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://codewithhugo.com/better-http-polling-with-rxjs-5/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #JavaScript 
              #reactive programming  </span>
              
              <h2 class="post-card-title">Better HTTP Polling with RxJS 5</h2>
          </header>
          <section class="post-card-excerpt">
              
                <p>Here is the implementation for a function that takes a Promise-based fetch function and a function that decides if a response has been successful (from a polling perspective) and polls the fetch function until the isSuccess function returns true:

 ...  </p>
              
          </section>
      </a>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://cdn-images-1.medium.com/fit/c/200/200/0*Rb-aDjpTtV1UZA4O.jpeg" alt="Author" />
          <span class="post-card-author"><a href="/">Hugo Di Francesco</a></span>
      </footer>
    </div>
</article>
      
    </div>
  </div>
</aside>

<div class="floating-header">
  <div class="floating-header-logo">
    <a href="https://codewithhugo.com/">
      
      <span>Code with Hugo</span>
    </a>
  </div>
  <span class="floating-header-divider">&mdash;</span>
  <div class="floating-header-title">ES6 by example: a module/CLI to wait for Postgres in docker-compose</div>
  <div class="floating-header-share">
    <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
     <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/></svg>
    </div>
    
    <a class="floating-header-share-tw" href="https://twitter.com/share?text=ES6%20by%20example%3a%20a%20module%2fCLI%20to%20wait%20for%20Postgres%20in%20docker-compose&amp;url=https%3a%2f%2fcodewithhugo.com%2fes6-by-example-a-module%2fcli-to-wait-for-postgres-in-docker-compose%2f"
          onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
      </a>
      <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcodewithhugo.com%2fes6-by-example-a-module%2fcli-to-wait-for-postgres-in-docker-compose%2f"
          onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
      </a>
  </div>

  <progress class="progress" value="0">
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>
  </progress>
</div>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/">Code with Hugo</a>  <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        <a href="https://twitter.com/hugo__df" target="_blank" rel="noopener">Twitter</a>
        <a href="https://github.com/HugoDF" target="_blank" rel="noopener">Github</a>
        
        <a href="https://medium.com/@hugo__df" target="_blank" rel="noopener">Medium</a>
    </nav>  
  </div>
</footer>

</div>

<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://codewithhugo.com/js/jquery.fitvids.js"></script>




  <!-- Google Analytics -->
  <script>
    var _gaq=[['_setAccount','UA-60469708-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>



<script async src="//cdn.simpleanalytics.io/hello.js"></script> 
<noscript><img src="//api.simpleanalytics.io/hello.gif" alt=""></noscript>

    <script>





$(document).ready(function () {
    
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>
</body></html>
